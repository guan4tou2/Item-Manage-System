{%extends 'template.html' %}
{%block title%}ä½ç½®è¨­å®š - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <h1>ğŸ  ä½ç½®è¨­å®š</h1>
    <p class="lead">ç¶­è­·æ¨“å±¤ã€æˆ¿é–“ã€å€åŸŸé¸å–®ï¼Œä¾›æ–°å¢èˆ‡æœå°‹ä½¿ç”¨</p>
  </div>
</div>
{%endblock%}

{%block body%}
<div class="container">
  <div class="row g-4">
    <!-- å·¦å´ï¼šæ–°å¢ä½ç½® -->
    <div class="col-lg-5 animate-fadeInUp stagger-1">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>æ–°å¢ä½ç½®é¸é …</h5>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('locations.manage_locations') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="action" value="create"/>
            
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-building me-1"></i>æ¨“å±¤</label>
              <input type="text" class="form-control" name="floor" placeholder="ä¾‹å¦‚ï¼š1Fã€2Fã€B1">
              <small class="text-muted">è¼¸å…¥æ¨“å±¤åç¨±</small>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-door-open me-1"></i>æˆ¿é–“</label>
              <input type="text" class="form-control" name="room" placeholder="ä¾‹å¦‚ï¼šå®¢å»³ã€ä¸»è‡¥ã€æ›¸æˆ¿">
              <small class="text-muted">è¼¸å…¥æˆ¿é–“åç¨±</small>
            </div>
            
            <div class="mb-3">
              <label class="form-label"><i class="fas fa-th-large me-1"></i>å€åŸŸ/æ«ƒä½</label>
              <input type="text" class="form-control" name="zone" placeholder="ä¾‹å¦‚ï¼šè¡£æ«ƒã€æ›¸æ«ƒã€æŠ½å±œ">
              <small class="text-muted">è¼¸å…¥å€åŸŸæˆ–æ«ƒä½åç¨±</small>
            </div>
            
            <div class="alert alert-info small">
              <i class="fas fa-info-circle me-1"></i>
              å¯ä»¥åªå¡«å¯«å…¶ä¸­ä¸€å€‹æ¬„ä½ï¼Œç³»çµ±æœƒè‡ªå‹•æ–°å¢åˆ°å°æ‡‰çš„é¸é …åˆ—è¡¨ä¸­
            </div>
            
            <button type="submit" class="btn btn-primary w-100">
              <i class="fas fa-plus me-2"></i>æ–°å¢ä½ç½®é¸é …
            </button>
          </form>
        </div>
      </div>
      
      <!-- å¿«é€Ÿçµ±è¨ˆ -->
      <div class="card mt-4">
        <div class="card-body">
          <h6 class="text-muted mb-3">ä½ç½®é¸é …çµ±è¨ˆ</h6>
          <div class="row text-center">
            <div class="col-4">
              <div class="fs-3 fw-bold text-primary">{{ floors|length }}</div>
              <small class="text-muted">æ¨“å±¤</small>
            </div>
            <div class="col-4">
              <div class="fs-3 fw-bold text-success">{{ rooms|length }}</div>
              <small class="text-muted">æˆ¿é–“</small>
            </div>
            <div class="col-4">
              <div class="fs-3 fw-bold text-info">{{ zones|length }}</div>
              <small class="text-muted">å€åŸŸ</small>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- å³å´ï¼šç¾æœ‰ä½ç½®åˆ—è¡¨ -->
    <div class="col-lg-7 animate-fadeInUp stagger-2">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>ç¾æœ‰ä½ç½®é¸é …</h5>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted d-none d-md-inline">
              <i class="fas fa-grip-vertical me-1"></i>æ‹–æ›³æ’åº
            </small>
            <span class="badge bg-secondary">{{ locations|length }} ç­†</span>
          </div>
        </div>
        <div class="card-body p-0">
          {%if locations%}
          <div class="table-responsive">
            <table class="table table-hover mb-0 location-table">
              <thead>
                <tr>
                  <th style="width: 40px;" class="d-none d-md-table-cell"></th>
                  <th style="width: 22%;">æ¨“å±¤</th>
                  <th style="width: 22%;">æˆ¿é–“</th>
                  <th style="width: 22%;">å€åŸŸ/æ«ƒä½</th>
                  <th style="width: 15%;" class="text-center">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="locationTableBody">
                {% for loc in locations %}
                <tr class="location-row" id="row-{{loc._id}}" draggable="true" data-id="{{loc._id}}">
                  <!-- æ‹–æ›³æ‰‹æŸ„ -->
                  <td class="drag-handle d-none d-md-table-cell" style="cursor: grab; color: var(--gray-400);">
                    <i class="fas fa-grip-vertical"></i>
                  </td>
                  <!-- é¡¯ç¤ºæ¨¡å¼ -->
                  <td class="view-mode">{{loc.floor or '-'}}</td>
                  <td class="view-mode">{{loc.room or '-'}}</td>
                  <td class="view-mode">{{loc.zone or '-'}}</td>
                  <td class="view-mode text-center">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary btn-action" onclick="startEdit('{{loc._id}}', '{{loc.floor or ''}}', '{{loc.room or ''}}', '{{loc.zone or ''}}')" title="ç·¨è¼¯">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-action" onclick="confirmDelete('{{loc._id}}', '{{loc.floor or ''}} {{loc.room or ''}} {{loc.zone or ''}}')" title="åˆªé™¤">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                  
                  <!-- ç·¨è¼¯æ¨¡å¼ (éš±è—) -->
                  <td class="edit-mode d-none">
                    <input type="text" class="form-control form-control-sm" id="edit-floor-{{loc._id}}" value="{{loc.floor or ''}}">
                  </td>
                  <td class="edit-mode d-none">
                    <input type="text" class="form-control form-control-sm" id="edit-room-{{loc._id}}" value="{{loc.room or ''}}">
                  </td>
                  <td class="edit-mode d-none">
                    <input type="text" class="form-control form-control-sm" id="edit-zone-{{loc._id}}" value="{{loc.zone or ''}}">
                  </td>
                  <td class="edit-mode d-none text-center">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-success btn-action" onclick="saveEdit('{{loc._id}}')" title="å„²å­˜">
                        <i class="fas fa-check"></i>
                      </button>
                      <button type="button" class="btn btn-secondary btn-action" onclick="cancelEdit('{{loc._id}}')" title="å–æ¶ˆ">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {%else%}
          <div class="text-center py-5">
            <i class="fas fa-map-marker-alt fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">å°šç„¡ä½ç½®é¸é …</h5>
            <p class="text-muted">ä½¿ç”¨å·¦å´è¡¨å–®æ–°å¢ç¬¬ä¸€å€‹ä½ç½®å§ï¼</p>
          </div>
          {%endif%}
        </div>
      </div>
      
      <!-- ä½ç½®é¸é …é è¦½ -->
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white py-2">
              <small><i class="fas fa-building me-1"></i>å¯ç”¨æ¨“å±¤</small>
            </div>
            <div class="card-body p-2">
              <div class="d-flex flex-wrap gap-1">
                {%for f in floors%}
                <span class="badge bg-light text-dark">{{f}}</span>
                {%endfor%}
                {%if not floors%}
                <span class="text-muted small">å°šç„¡æ¨“å±¤</span>
                {%endif%}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-success">
            <div class="card-header bg-success text-white py-2">
              <small><i class="fas fa-door-open me-1"></i>å¯ç”¨æˆ¿é–“</small>
            </div>
            <div class="card-body p-2">
              <div class="d-flex flex-wrap gap-1">
                {%for r in rooms%}
                <span class="badge bg-light text-dark">{{r}}</span>
                {%endfor%}
                {%if not rooms%}
                <span class="text-muted small">å°šç„¡æˆ¿é–“</span>
                {%endif%}
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card border-info">
            <div class="card-header bg-info text-white py-2">
              <small><i class="fas fa-th-large me-1"></i>å¯ç”¨å€åŸŸ</small>
            </div>
            <div class="card-body p-2">
              <div class="d-flex flex-wrap gap-1">
                {%for z in zones%}
                <span class="badge bg-light text-dark">{{z}}</span>
                {%endfor%}
                {%if not zones%}
                <span class="text-muted small">å°šç„¡å€åŸŸ</span>
                {%endif%}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åˆªé™¤ç¢ºèª Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>ç¢ºèªåˆªé™¤</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center py-4">
        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
        <p>ç¢ºå®šè¦åˆªé™¤ä½ç½®é¸é …ã€Œ<strong id="delete-location-name"></strong>ã€å—ï¼Ÿ</p>
        <p class="text-muted small">æ­¤æ“ä½œç„¡æ³•å¾©åŸ</p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <form id="deleteForm" method="post" action="{{ url_for('locations.manage_locations') }}" class="d-inline">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="action" value="delete"/>
          <input type="hidden" name="loc_id" id="delete-loc-id"/>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-1"></i>ç¢ºèªåˆªé™¤
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- éš±è—çš„ç·¨è¼¯è¡¨å–® -->
<form id="editForm" method="post" action="{{ url_for('locations.manage_locations') }}" class="d-none">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
  <input type="hidden" name="action" value="update"/>
  <input type="hidden" name="loc_id" id="edit-form-loc-id"/>
  <input type="hidden" name="floor" id="edit-form-floor"/>
  <input type="hidden" name="room" id="edit-form-room"/>
  <input type="hidden" name="zone" id="edit-form-zone"/>
</form>
{%endblock%}

{%block js%}
<script>
let currentEditId = null;

function startEdit(id, floor, room, zone) {
  // å¦‚æœå·²æœ‰å…¶ä»–æ­£åœ¨ç·¨è¼¯çš„è¡Œï¼Œå…ˆå–æ¶ˆ
  if (currentEditId && currentEditId !== id) {
    cancelEdit(currentEditId);
  }
  
  currentEditId = id;
  const row = document.getElementById('row-' + id);
  row.classList.add('editing');
  
  // éš±è—é¡¯ç¤ºæ¨¡å¼ï¼Œé¡¯ç¤ºç·¨è¼¯æ¨¡å¼
  row.querySelectorAll('.view-mode').forEach(el => el.classList.add('d-none'));
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.remove('d-none'));
  
  // èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
  document.getElementById('edit-floor-' + id).focus();
}

function cancelEdit(id) {
  currentEditId = null;
  const row = document.getElementById('row-' + id);
  row.classList.remove('editing');
  
  // é¡¯ç¤ºé¡¯ç¤ºæ¨¡å¼ï¼Œéš±è—ç·¨è¼¯æ¨¡å¼
  row.querySelectorAll('.view-mode').forEach(el => el.classList.remove('d-none'));
  row.querySelectorAll('.edit-mode').forEach(el => el.classList.add('d-none'));
}

function saveEdit(id) {
  const floor = document.getElementById('edit-floor-' + id).value;
  const room = document.getElementById('edit-room-' + id).value;
  const zone = document.getElementById('edit-zone-' + id).value;
  
  // å¡«å…¥éš±è—è¡¨å–®ä¸¦æäº¤
  document.getElementById('edit-form-loc-id').value = id;
  document.getElementById('edit-form-floor').value = floor;
  document.getElementById('edit-form-room').value = room;
  document.getElementById('edit-form-zone').value = zone;
  document.getElementById('editForm').submit();
}

function confirmDelete(id, name) {
  document.getElementById('delete-loc-id').value = id;
  document.getElementById('delete-location-name').textContent = name.trim() || '(ç©ºç™½)';
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// æŒ‰ Enter å„²å­˜ï¼ŒæŒ‰ Esc å–æ¶ˆ
document.addEventListener('keydown', function(e) {
  if (currentEditId) {
    if (e.key === 'Enter') {
      e.preventDefault();
      saveEdit(currentEditId);
    } else if (e.key === 'Escape') {
      cancelEdit(currentEditId);
    }
  }
});

// ========================================
// æ‹–æ”¾æ’åºåŠŸèƒ½
// ========================================
let draggedRow = null;

document.addEventListener('DOMContentLoaded', function() {
  const tbody = document.getElementById('locationTableBody');
  if (!tbody) return;
  
  const rows = tbody.querySelectorAll('.location-row');
  
  rows.forEach(row => {
    // æ‹–æ›³é–‹å§‹
    row.addEventListener('dragstart', function(e) {
      draggedRow = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    });
    
    // æ‹–æ›³çµæŸ
    row.addEventListener('dragend', function() {
      this.classList.remove('dragging');
      draggedRow = null;
      
      // ç§»é™¤æ‰€æœ‰æ‹–æ›³ç›¸é—œæ¨£å¼
      rows.forEach(r => {
        r.classList.remove('drag-over', 'drag-over-top', 'drag-over-bottom');
      });
      
      // å„²å­˜æ–°é †åº
      saveNewOrder();
    });
    
    // æ‹–æ›³ç¶“é
    row.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (this === draggedRow) return;
      
      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      
      rows.forEach(r => r.classList.remove('drag-over-top', 'drag-over-bottom'));
      
      if (e.clientY < midY) {
        this.classList.add('drag-over-top');
      } else {
        this.classList.add('drag-over-bottom');
      }
    });
    
    // æ‹–æ›³é›¢é–‹
    row.addEventListener('dragleave', function() {
      this.classList.remove('drag-over-top', 'drag-over-bottom');
    });
    
    // æ”¾ä¸‹
    row.addEventListener('drop', function(e) {
      e.preventDefault();
      
      if (this === draggedRow) return;
      
      const rect = this.getBoundingClientRect();
      const midY = rect.top + rect.height / 2;
      
      if (e.clientY < midY) {
        this.parentNode.insertBefore(draggedRow, this);
      } else {
        this.parentNode.insertBefore(draggedRow, this.nextSibling);
      }
    });
  });
});

function saveNewOrder() {
  const tbody = document.getElementById('locationTableBody');
  const rows = tbody.querySelectorAll('.location-row');
  const order = [];
  
  rows.forEach((row, index) => {
    order.push({
      id: row.dataset.id,
      order: index
    });
  });
  
  // ç™¼é€æ–°é †åºåˆ°å¾Œç«¯ï¼ˆå¦‚æœæœ‰å¯¦ä½œæ’åº APIï¼‰
  fetch('{{ url_for("locations.update_order") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': '{{ csrf_token() }}'
    },
    body: JSON.stringify({ order: order })
  }).then(res => res.json())
    .then(data => {
      if (data.success) {
        // å¯é¸ï¼šé¡¯ç¤ºæˆåŠŸæç¤º
      }
    })
    .catch(err => console.log('æ’åºå„²å­˜å¤±æ•—'));
}
</script>
{%endblock%}
