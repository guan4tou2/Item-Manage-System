{%extends 'template.html' %}
{%block title%}ç®¡ç†ç‰©å“ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container-fluid">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h1>ğŸ“¦ ç®¡ç†ç‰©å“</h1>
        <p class="lead mb-0">ç·¨è¼¯ç‰©å“è³‡è¨Šã€æ›´æ–°ä½ç½®æˆ–åˆªé™¤ç‰©å“</p>
      </div>
      <div class="import-export-group">
        <a href="{{ url_for('items.export_items', format='json') }}" class="btn btn-outline-primary">
          <i class="fas fa-download me-1"></i>åŒ¯å‡º JSON
        </a>
        <a href="{{ url_for('items.export_items', format='csv') }}" class="btn btn-outline-success">
          <i class="fas fa-file-csv me-1"></i>åŒ¯å‡º CSV
        </a>
        <a href="{{ url_for('items.export_restock') }}" class="btn btn-outline-danger">
          <i class="fas fa-clipboard-list me-1"></i>è£œè²¨æ¸…å–®
        </a>
        <a href="{{ url_for('items.import_items') }}" class="btn btn-warning">
          <i class="fas fa-upload me-1"></i>åŒ¯å…¥
        </a>
      </div>
    </div>
  </div>
  
  <!-- å¿«é€Ÿæ“ä½œæç¤º -->
  <div class="alert alert-info alert-dismissible fade show mb-4 animate-fadeInUp stagger-1" role="alert">
    <div class="d-flex align-items-center">
      <i class="fas fa-info-circle fa-2x me-3"></i>
      <div>
        <strong>ç®¡ç†æç¤ºï¼š</strong>
        <ul class="mb-0 mt-1">
          <li>é»æ“Šã€Œç·¨è¼¯ã€å¯ä¿®æ”¹ç‰©å“å®Œæ•´è³‡è¨Š</li>
          <li>ä½¿ç”¨ä¸‹æ–¹çš„ä½ç½®é¸å–®å¯å¿«é€Ÿæ›´æ–°ç‰©å“ä½ç½®</li>
          <li>ä¸‹è¼‰ QR Code è²¼åœ¨ç‰©å“ä¸Šæ–¹ä¾¿è­˜åˆ¥</li>
        </ul>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="é—œé–‰"></button>
  </div>
  
  <!-- çµ±è¨ˆæ‘˜è¦ -->
  <div class="row g-3 mb-4 animate-fadeInUp stagger-2">
    <div class="col-6 col-md-3">
      <div class="stats-card bg-primary text-white">
        <div class="icon"><i class="fas fa-box"></i></div>
        <h2>{{ pagination.total if pagination else items|length }}</h2>
        <h5>ç¸½ç‰©å“æ•¸</h5>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stats-card bg-danger text-white">
        <div class="icon"><i class="fas fa-exclamation-triangle"></i></div>
        <h2>{{ items|selectattr('WarrantyStatus', 'eq', 'expired')|list|length }}</h2>
        <h5>ä¿å›ºéæœŸ</h5>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stats-card bg-warning text-white">
        <div class="icon"><i class="fas fa-clock"></i></div>
        <h2>{{ items|selectattr('WarrantyStatus', 'eq', 'near')|list|length }}</h2>
        <h5>å³å°‡åˆ°æœŸ</h5>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <a href="{{ url_for('items.additem') }}" class="text-decoration-none">
        <div class="stats-card bg-success text-white">
          <div class="icon"><i class="fas fa-plus"></i></div>
          <h2>+</h2>
          <h5>æ–°å¢ç‰©å“</h5>
        </div>
      </a>
    </div>
  </div>
</div>
{%endblock%}

{%block card%}
<!-- æ‰‹æ©Ÿç‰ˆæ‰¹é‡é¸æ“‡æ¨¡å¼æç¤º -->
<div class="mobile-select-hint d-md-none" id="mobileSelectHint">
  <i class="fas fa-hand-pointer me-2"></i>é•·æŒ‰ç‰©å“å¡ç‰‡é€²å…¥é¸æ“‡æ¨¡å¼
</div>

<!-- æ‰¹é‡æ“ä½œå·¥å…·åˆ— -->
<div class="batch-toolbar hidden" id="batchToolbar">
  <span><i class="fas fa-check-square me-2"></i>å·²é¸æ“‡ <span class="batch-count" id="selectedCount">0</span> é …</span>
  <div class="btn-group btn-group-sm">
    <button type="button" class="btn btn-outline-light" onclick="batchMove()" title="æ‰¹é‡ç§»å‹•">
      <i class="fas fa-arrows-alt me-1"></i><span class="d-none d-sm-inline">ç§»å‹•</span>
    </button>
    <button type="button" class="btn btn-outline-danger" onclick="batchDelete()" title="æ‰¹é‡åˆªé™¤">
      <i class="fas fa-trash me-1"></i><span class="d-none d-sm-inline">åˆªé™¤</span>
    </button>
  </div>
  <button type="button" class="btn btn-sm btn-outline-light" onclick="exitSelectMode()">
    <i class="fas fa-times"></i>
  </button>
</div>

<!-- æ‰‹æ©Ÿç‰ˆåº•éƒ¨æ“ä½œæ¬„ï¼ˆé¸æ“‡æ¨¡å¼æ™‚é¡¯ç¤ºï¼‰ -->
<div class="mobile-batch-bar d-md-none hidden" id="mobileBatchBar">
  <div class="d-flex justify-content-between align-items-center px-3 py-2">
    <div>
      <button type="button" class="btn btn-sm btn-outline-light" onclick="selectAllMobile()">
        <i class="fas fa-check-double me-1"></i>å…¨é¸
      </button>
    </div>
    <div>
      <span class="text-white">å·²é¸ <strong id="mobileSelectedCount">0</strong></span>
    </div>
    <div class="btn-group btn-group-sm">
      <button type="button" class="btn btn-light" onclick="batchMove()">
        <i class="fas fa-arrows-alt"></i>
      </button>
      <button type="button" class="btn btn-danger" onclick="batchDelete()">
        <i class="fas fa-trash"></i>
      </button>
    </div>
  </div>
</div>

<div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
  {%for item in items%}
  <div class="col">
    <div class="card h-100 batch-item" data-item-id="{{item.ItemID}}" data-item-name="{{item.ItemName}}">
      <div class="row g-0">
        <!-- æ‰¹é‡é¸æ“‡å‹¾é¸æ¡† -->
        <div class="batch-checkbox position-absolute top-0 start-0 m-2 z-1">
          <input type="checkbox" class="form-check-input item-checkbox" onchange="updateSelection()" style="width: 20px; height: 20px;">
        </div>
        <!-- ç‰©å“åœ–ç‰‡ (å·¦å´) -->
        <div class="col-4">
          {%if item.ItemPic%}
          <img
            src="{{ url_for('items.uploaded_file', filename=item.ItemThumb or item.ItemPic) }}"
            class="img-fluid rounded-start h-100"
            alt="{{ item.ItemName }}"
            style="object-fit: cover; min-height: 200px;"
            loading="lazy"
          />
          {%else%}
          <div class="bg-light d-flex align-items-center justify-content-center h-100 rounded-start" style="min-height: 200px;">
            <i class="fas fa-image fa-3x text-muted"></i>
          </div>
          {%endif%}
        </div>
        
        <!-- ç‰©å“è³‡è¨Š (å³å´) -->
        <div class="col-8">
          <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title mb-0 text-truncate" style="max-width: 70%;" title="{{item.ItemName}}">
                {{item.ItemName}}
              </h5>
              <!-- ç‹€æ…‹æ¨™ç±¤ -->
              <div class="d-flex gap-1">
                {% if item.WarrantyStatus=='expired' %}
                <span class="badge bg-danger" data-tooltip="ä¿å›ºå·²éæœŸ">
                  <i class="fas fa-exclamation-triangle"></i>
                </span>
                {% elif item.WarrantyStatus=='near' %}
                <span class="badge bg-warning" data-tooltip="ä¿å›ºå³å°‡åˆ°æœŸ">
                  <i class="fas fa-clock"></i>
                </span>
                {% endif %}
              </div>
            </div>
            
            <p class="card-text small text-muted mb-2">
              <i class="fas fa-hashtag me-1"></i>{{item.ItemID}}
              {%if item.ItemType%}
              <span class="badge bg-secondary ms-2">{{item.ItemType}}</span>
              {%endif%}
            </p>
            
            {%if item.ItemStorePlace%}
            <p class="card-text small mb-1">
              <i class="fas fa-map-marker-alt text-danger me-1"></i>{{item.ItemStorePlace}}
            </p>
            {%endif%}
            
            {%if item.ItemFloor or item.ItemRoom or item.ItemZone%}
            <p class="card-text small text-muted mb-2">
              <i class="fas fa-home me-1"></i>{{item.ItemFloor}} {{item.ItemRoom}} {{item.ItemZone}}
            </p>
            {%endif%}
            
            <!-- å¿«é€Ÿæ“ä½œæŒ‰éˆ• -->
            <div class="d-flex gap-2 mt-3">
              <a href="{{ url_for('items.edititem', item_id=item.ItemID) }}" 
                 class="btn btn-primary btn-sm flex-grow-1">
                <i class="fas fa-edit me-1"></i>ç·¨è¼¯
              </a>
              <button type="button" 
                      class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="collapse" 
                      data-bs-target="#location-{{loop.index}}"
                      aria-expanded="false">
                <i class="fas fa-map-marker-alt"></i>
              </button>
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('items.qrcode_image', item_id=item.ItemID) }}" 
                   class="btn btn-outline-dark" data-tooltip="QR Code">
                  <i class="fas fa-qrcode"></i>
                </a>
                <a href="{{ url_for('items.barcode_image', item_id=item.ItemID) }}" 
                   class="btn btn-outline-dark" data-tooltip="æ¢ç¢¼">
                  <i class="fas fa-barcode"></i>
                </a>
              </div>
            </div>
          </div>
          
          <!-- å¿«é€Ÿæ›´æ–°ä½ç½® (æŠ˜ç–Šå€) -->
          <div class="collapse" id="location-{{loop.index}}">
            <div class="card-footer bg-light">
              <form method="POST" class="row g-2">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="item_id" value="{{item.ItemID}}" />
                
                <div class="col-12">
                  <input
                    type="text"
                    name="new_place"
                    class="form-control form-control-sm"
                    placeholder="è¼¸å…¥æ–°çš„æ”¾ç½®åœ°é»..."
                  />
                </div>
                
                <div class="col-4">
                  <select name="ItemFloor" class="form-select form-select-sm">
                    <option value="">æ¨“å±¤</option>
                    {% for f in floors %}
                    <option value="{{f}}" {% if item.ItemFloor == f %}selected{% endif %}>{{f}}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-4">
                  <select name="ItemRoom" class="form-select form-select-sm">
                    <option value="">æˆ¿é–“</option>
                    {% for r in rooms %}
                    <option value="{{r}}" {% if item.ItemRoom == r %}selected{% endif %}>{{r}}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-4">
                  <select name="ItemZone" class="form-select form-select-sm">
                    <option value="">å€åŸŸ</option>
                    {% for z in zones %}
                    <option value="{{z}}" {% if item.ItemZone == z %}selected{% endif %}>{{z}}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="col-12">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    <i class="fas fa-check me-1"></i>æ›´æ–°ä½ç½®
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {%endfor%}
</div>

{%if not items%}
<div class="empty-state animate-fadeInUp">
  <i class="fas fa-box-open"></i>
  <h3>é‚„æ²’æœ‰ä»»ä½•ç‰©å“</h3>
  <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€å€‹ç‰©å“å§ï¼</p>
  <a href="{{ url_for('items.additem') }}" class="btn btn-primary btn-lg">
    <i class="fas fa-plus me-2"></i>æ–°å¢ç‰©å“
  </a>
</div>
{%endif%}
{%endblock%}

{%block page%}
{% include "partials/pagination.html" %}
{%endblock%}

{%block modal%}
<!-- æ‰¹é‡ç§»å‹• Modal -->
<div class="modal fade" id="batchMoveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-arrows-alt me-2"></i>æ‰¹é‡ç§»å‹•ç‰©å“</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="batchMoveForm" method="post" action="{{ url_for('items.batch_move') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="item_ids" id="batchMoveItemIds"/>
        <div class="modal-body">
          <p>å°‡ç§»å‹• <strong id="batchMoveCount">0</strong> å€‹ç‰©å“åˆ°æ–°ä½ç½®</p>
          <div class="mb-3">
            <label class="form-label">æ–°æ”¾ç½®åœ°é»</label>
            <input type="text" class="form-control" name="new_place" placeholder="è¼¸å…¥æ–°çš„æ”¾ç½®åœ°é»...">
          </div>
          <div class="row g-2">
            <div class="col-4">
              <label class="form-label">æ¨“å±¤</label>
              <select name="ItemFloor" class="form-select">
                <option value="">é¸æ“‡...</option>
                {% for f in floors %}
                <option value="{{f}}">{{f}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-4">
              <label class="form-label">æˆ¿é–“</label>
              <select name="ItemRoom" class="form-select">
                <option value="">é¸æ“‡...</option>
                {% for r in rooms %}
                <option value="{{r}}">{{r}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-4">
              <label class="form-label">å€åŸŸ</label>
              <select name="ItemZone" class="form-select">
                <option value="">é¸æ“‡...</option>
                {% for z in zones %}
                <option value="{{z}}">{{z}}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check me-1"></i>ç¢ºèªç§»å‹•
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- æ‰¹é‡åˆªé™¤ Modal -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>ç¢ºèªæ‰¹é‡åˆªé™¤</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="batchDeleteForm" method="post" action="{{ url_for('items.batch_delete') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <input type="hidden" name="item_ids" id="batchDeleteItemIds"/>
        <div class="modal-body text-center py-4">
          <i class="fas fa-trash-alt fa-4x text-danger mb-3"></i>
          <h4>ç¢ºå®šè¦åˆªé™¤ <span id="batchDeleteCount">0</span> å€‹ç‰©å“å—ï¼Ÿ</h4>
          <p class="text-muted">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œæ‰€æœ‰é¸ä¸­çš„ç‰©å“å°‡è¢«æ°¸ä¹…åˆªé™¤ã€‚</p>
          <div id="batchDeleteList" class="text-start mt-3 p-3 bg-light rounded" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash me-1"></i>ç¢ºèªåˆªé™¤
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{%endblock%}

{%block js%}
<script>
const batchToolbar = document.getElementById('batchToolbar');
const selectedCount = document.getElementById('selectedCount');
const mobileBatchBar = document.getElementById('mobileBatchBar');
const mobileSelectedCount = document.getElementById('mobileSelectedCount');
const mobileSelectHint = document.getElementById('mobileSelectHint');

let isSelectMode = false;
let longPressTimer = null;

function getSelectedItems() {
  const items = [];
  document.querySelectorAll('.item-checkbox:checked').forEach(checkbox => {
    const card = checkbox.closest('.batch-item');
    items.push({
      id: card.dataset.itemId,
      name: card.dataset.itemName
    });
  });
  return items;
}

function updateSelection() {
  const selected = getSelectedItems();
  selectedCount.textContent = selected.length;
  
  if (mobileSelectedCount) {
    mobileSelectedCount.textContent = selected.length;
  }
  
  if (selected.length > 0) {
    batchToolbar.classList.remove('hidden');
    if (window.innerWidth < 768 && mobileBatchBar) {
      mobileBatchBar.classList.remove('hidden');
    }
  } else {
    batchToolbar.classList.add('hidden');
    if (mobileBatchBar) {
      mobileBatchBar.classList.add('hidden');
    }
    if (isSelectMode) {
      exitSelectMode();
    }
  }
}

function clearSelection() {
  document.querySelectorAll('.item-checkbox:checked').forEach(cb => cb.checked = false);
  updateSelection();
}

// é€²å…¥é¸æ“‡æ¨¡å¼
function enterSelectMode() {
  isSelectMode = true;
  document.body.classList.add('select-mode');
  
  // é¡¯ç¤ºæ‰€æœ‰å‹¾é¸æ¡†
  document.querySelectorAll('.batch-checkbox').forEach(el => {
    el.classList.add('visible');
  });
  
  // éš±è—æ‰‹æ©Ÿæç¤º
  if (mobileSelectHint) {
    mobileSelectHint.style.display = 'none';
  }
  
  // éœ‡å‹•åé¥‹
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
}

// é€€å‡ºé¸æ“‡æ¨¡å¼
function exitSelectMode() {
  isSelectMode = false;
  document.body.classList.remove('select-mode');
  
  // éš±è—å‹¾é¸æ¡†
  document.querySelectorAll('.batch-checkbox').forEach(el => {
    el.classList.remove('visible');
  });
  
  // æ¸…é™¤é¸æ“‡
  clearSelection();
  
  // é¡¯ç¤ºæ‰‹æ©Ÿæç¤º
  if (mobileSelectHint && window.innerWidth < 768) {
    mobileSelectHint.style.display = '';
  }
  
  // éš±è—å·¥å…·åˆ—
  if (mobileBatchBar) {
    mobileBatchBar.classList.add('hidden');
  }
  batchToolbar.classList.add('hidden');
}

// æ‰‹æ©Ÿå…¨é¸
function selectAllMobile() {
  document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = true);
  updateSelection();
}

function batchMove() {
  const selected = getSelectedItems();
  if (selected.length === 0) return;
  
  document.getElementById('batchMoveItemIds').value = selected.map(i => i.id).join(',');
  document.getElementById('batchMoveCount').textContent = selected.length;
  
  new bootstrap.Modal(document.getElementById('batchMoveModal')).show();
}

function batchDelete() {
  const selected = getSelectedItems();
  if (selected.length === 0) return;
  
  document.getElementById('batchDeleteItemIds').value = selected.map(i => i.id).join(',');
  document.getElementById('batchDeleteCount').textContent = selected.length;
  
  const listEl = document.getElementById('batchDeleteList');
  listEl.innerHTML = selected.map(i => `<div class="small"><i class="fas fa-box me-2 text-muted"></i>${i.name}</div>`).join('');
  
  new bootstrap.Modal(document.getElementById('batchDeleteModal')).show();
}

// é•·æŒ‰é€²å…¥é¸æ“‡æ¨¡å¼ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
document.querySelectorAll('.batch-item').forEach(card => {
  // è§¸æ§é–‹å§‹
  card.addEventListener('touchstart', function(e) {
    if (!isSelectMode) {
      longPressTimer = setTimeout(() => {
        enterSelectMode();
        // é¸ä¸­ç•¶å‰å¡ç‰‡
        const checkbox = card.querySelector('.item-checkbox');
        if (checkbox) {
          checkbox.checked = true;
          updateSelection();
        }
      }, 500); // 500ms é•·æŒ‰
    }
  });
  
  // è§¸æ§çµæŸæˆ–å–æ¶ˆ
  card.addEventListener('touchend', function() {
    clearTimeout(longPressTimer);
  });
  
  card.addEventListener('touchmove', function() {
    clearTimeout(longPressTimer);
  });
  
  // é¸æ“‡æ¨¡å¼ä¸‹é»æ“Šåˆ‡æ›é¸ä¸­
  card.addEventListener('click', function(e) {
    if (isSelectMode && e.target.type !== 'checkbox') {
      const checkbox = card.querySelector('.item-checkbox');
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateSelection();
      }
    }
  });
});

// Shift+Click å¤šé¸ï¼ˆæ¡Œé¢ç‰ˆï¼‰
let lastChecked = null;
document.querySelectorAll('.item-checkbox').forEach(checkbox => {
  checkbox.addEventListener('click', function(e) {
    if (e.shiftKey && lastChecked) {
      const checkboxes = Array.from(document.querySelectorAll('.item-checkbox'));
      const start = checkboxes.indexOf(lastChecked);
      const end = checkboxes.indexOf(this);
      const range = checkboxes.slice(Math.min(start, end), Math.max(start, end) + 1);
      range.forEach(cb => cb.checked = lastChecked.checked);
    }
    lastChecked = this;
    updateSelection();
  });
});

// é»æ“Šç©ºç™½è™•é€€å‡ºé¸æ“‡æ¨¡å¼ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
document.addEventListener('click', function(e) {
  if (isSelectMode && 
      !e.target.closest('.batch-item') && 
      !e.target.closest('.batch-toolbar') &&
      !e.target.closest('.mobile-batch-bar') &&
      !e.target.closest('.modal')) {
    exitSelectMode();
  }
});
</script>
{%endblock%}
