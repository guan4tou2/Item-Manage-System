{%extends 'template.html' %}
{%block title%}{{item.ItemName}} - 物品詳情{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container">
  <!-- 麵包屑導航 -->
  <nav aria-label="breadcrumb" class="mb-4 animate-fadeInUp">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{url_for('items.home')}}"><i class="fas fa-home"></i> 首頁</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{item.ItemName}}</li>
    </ol>
  </nav>
</div>
{%endblock%}

{%block body%}
<div class="container">
  <div class="row g-4">
    <!-- 左側：照片區域 -->
    <div class="col-lg-5 animate-fadeInUp">
      <div class="item-photo-container">
        {%if item.ItemPic%}
        <img
          src="{{ url_for('items.uploaded_file', filename=item.ItemPic) }}"
          alt="{{ item.ItemName }}"
          class="img-fluid rounded-4 shadow-lg w-100"
          style="max-height: 500px; object-fit: cover;"
          id="mainPhoto"
        />
        {%else%}
        <div class="no-photo-placeholder d-flex align-items-center justify-content-center bg-light rounded-4" style="height: 400px;">
          <div class="text-center text-muted">
            <i class="fas fa-image fa-5x mb-3 opacity-50"></i>
            <p>尚未上傳照片</p>
          </div>
        </div>
        {%endif%}
        
        <!-- 多圖縮略圖列表 -->
        {%if item.ItemPics and item.ItemPics|length > 1%}
        <div class="photo-thumbnails mt-3 d-flex gap-2 flex-wrap">
          {%for pic in item.ItemPics%}
          <img
            src="{{ url_for('items.uploaded_file', filename=pic) }}"
            alt="照片 {{loop.index}}"
            class="photo-thumb rounded {%if loop.first%}active{%endif%}"
            onclick="switchPhoto('{{ url_for('items.uploaded_file', filename=pic) }}', this)"
          />
          {%endfor%}
        </div>
        {%endif%}
      </div>
    </div>
    
    <!-- 右側：物品資訊 -->
    <div class="col-lg-7 animate-fadeInUp stagger-1">
      <div class="item-detail-card">
        <!-- 標題與狀態 -->
        <div class="d-flex justify-content-between align-items-start mb-3">
          <div>
            <h1 class="item-title mb-2">{{item.ItemName}}</h1>
            <p class="text-muted mb-0">
              <i class="fas fa-hashtag me-1"></i>{{item.ItemID}}
            </p>
          </div>
          <div class="d-flex flex-column gap-1 align-items-end">
            {% if item.WarrantyStatus=='expired' %}
            <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>保固過期</span>
            {% elif item.WarrantyStatus=='near' %}
            <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>保固即將到期</span>
            {% endif %}
            {% if item.UsageStatus=='expired' %}
            <span class="badge bg-danger"><i class="fas fa-hourglass-end me-1"></i>使用過期</span>
            {% elif item.UsageStatus=='near' %}
            <span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half me-1"></i>使用期限將至</span>
            {% endif %}
          </div>
        </div>
        
        <!-- 類型標籤 -->
        {%if item.ItemType%}
        <div class="mb-4">
          <span class="badge bg-primary fs-6">
            <i class="fas fa-tag me-1"></i>{{item.ItemType}}
          </span>
        </div>
        {%endif%}
        
        <!-- 詳細資訊卡片 -->
        <div class="info-sections">
          <!-- 位置資訊 -->
          <div class="info-section">
            <h5 class="info-section-title">
              <i class="fas fa-map-marker-alt text-danger"></i>
              放置位置
            </h5>
            <div class="info-content">
              {%if item.ItemStorePlace%}
              <p class="mb-2 fs-5"><strong>{{item.ItemStorePlace}}</strong></p>
              {%endif%}
              {%if item.ItemFloor or item.ItemRoom or item.ItemZone%}
              <p class="text-muted mb-0">
                <i class="fas fa-building me-1"></i>
                {% if item.ItemFloor %}{{item.ItemFloor}}{% endif %}
                {% if item.ItemRoom %} → {{item.ItemRoom}}{% endif %}
                {% if item.ItemZone %} → {{item.ItemZone}}{% endif %}
              </p>
              {%endif%}
              {%if not item.ItemStorePlace and not item.ItemFloor%}
              <p class="text-muted mb-0">未設定位置</p>
              {%endif%}
            </div>
          </div>
          
          <!-- 擁有者與日期 -->
          <div class="info-section">
            <h5 class="info-section-title">
              <i class="fas fa-user text-info"></i>
              擁有者資訊
            </h5>
            <div class="row">
              <div class="col-6">
                <p class="text-muted small mb-1">擁有者</p>
                <p class="mb-0"><strong>{{item.ItemOwner or '未設定'}}</strong></p>
              </div>
              <div class="col-6">
                <p class="text-muted small mb-1">取得日期</p>
                <p class="mb-0"><strong>{{item.ItemGetDate or '未設定'}}</strong></p>
              </div>
            </div>
          </div>
          
          <!-- 保固與期限 -->
          {%if item.WarrantyExpiry or item.UsageExpiry%}
          <div class="info-section">
            <h5 class="info-section-title">
              <i class="fas fa-shield-alt text-success"></i>
              保固與期限
            </h5>
            <div class="row">
              {%if item.WarrantyExpiry%}
              <div class="col-6">
                <p class="text-muted small mb-1">保固截止</p>
                <p class="mb-0 {%if item.WarrantyStatus=='expired'%}text-danger{%elif item.WarrantyStatus=='near'%}text-warning{%endif%}">
                  <strong>{{item.WarrantyExpiry}}</strong>
                  {%if item.WarrantyStatus=='expired'%}
                  <small>(已過期)</small>
                  {%elif item.WarrantyStatus=='near'%}
                  <small>(即將到期)</small>
                  {%endif%}
                </p>
              </div>
              {%endif%}
              {%if item.UsageExpiry%}
              <div class="col-6">
                <p class="text-muted small mb-1">使用期限</p>
                <p class="mb-0 {%if item.UsageStatus=='expired'%}text-danger{%elif item.UsageStatus=='near'%}text-warning{%endif%}">
                  <strong>{{item.UsageExpiry}}</strong>
                  {%if item.UsageStatus=='expired'%}
                  <small>(已過期)</small>
                  {%elif item.UsageStatus=='near'%}
                  <small>(即將到期)</small>
                  {%endif%}
                </p>
              </div>
              {%endif%}
            </div>
          </div>
          {%endif%}
          
          <!-- 物品描述 -->
          {%if item.ItemDesc%}
          <div class="info-section">
            <h5 class="info-section-title">
              <i class="fas fa-align-left text-secondary"></i>
              物品描述
            </h5>
            <p class="mb-0" style="white-space: pre-wrap;">{{item.ItemDesc}}</p>
          </div>
          {%endif%}
        </div>
        
        <!-- 操作按鈕 -->
        <div class="action-buttons mt-4 pt-4 border-top">
          <div class="d-flex flex-wrap gap-2">
            {%if User.admin%}
            <a href="{{ url_for('items.edititem', item_id=item.ItemID) }}" class="btn btn-primary btn-lg">
              <i class="fas fa-edit me-2"></i>編輯物品
            </a>
            {%endif%}
            <a href="{{ url_for('items.search') }}?q={{item.ItemName}}" class="btn btn-outline-secondary btn-lg">
              <i class="fas fa-search me-2"></i>搜尋相似
            </a>
            <div class="btn-group btn-lg">
              <a href="{{ url_for('items.qrcode_image', item_id=item.ItemID) }}" class="btn btn-outline-dark">
                <i class="fas fa-qrcode me-1"></i>QR Code
              </a>
              <a href="{{ url_for('items.barcode_image', item_id=item.ItemID) }}" class="btn btn-outline-dark">
                <i class="fas fa-barcode me-1"></i>條碼
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 移動歷史記錄 -->
  {%if item.move_history%}
  <div class="row mt-5">
    <div class="col-12 animate-fadeInUp stagger-2">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><i class="fas fa-history me-2"></i>位置變更記錄</h5>
        </div>
        <div class="card-body">
          <div class="timeline">
            {%for record in item.move_history%}
            <div class="timeline-item">
              <div class="timeline-marker"></div>
              <div class="timeline-content">
                <p class="timeline-date text-muted small">{{record.date}}</p>
                <p class="mb-0">
                  <span class="text-muted">{{record.from_location or '(未知)'}}</span>
                  <i class="fas fa-arrow-right mx-2 text-primary"></i>
                  <strong>{{record.to_location}}</strong>
                </p>
              </div>
            </div>
            {%endfor%}
          </div>
        </div>
      </div>
    </div>
  </div>
  {%endif%}
  
  <!-- 關聯物品 -->
  <div class="row mt-5">
    <div class="col-12 animate-fadeInUp stagger-3">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-link me-2"></i>關聯物品</h5>
          {%if User.admin%}
          <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addRelatedModal">
            <i class="fas fa-plus me-1"></i>新增關聯
          </button>
          {%endif%}
        </div>
        <div class="card-body" id="relatedItemsContainer">
          <div class="text-center py-3" id="relatedLoading">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2 text-muted">載入中...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 新增關聯 Modal -->
{%if User.admin%}
<div class="modal fade" id="addRelatedModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-link me-2"></i>新增關聯物品</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">關聯物品 ID</label>
          <input type="text" class="form-control" id="relatedItemId" placeholder="輸入物品 ID">
          <small class="text-muted">輸入要關聯的物品 ID</small>
        </div>
        <div class="mb-3">
          <label class="form-label">關聯類型</label>
          <select class="form-select" id="relationType">
            <option value="配件">配件</option>
            <option value="組合">組合</option>
            <option value="替代品">替代品</option>
            <option value="相關">相關</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" onclick="addRelatedItem()">
          <i class="fas fa-plus me-1"></i>新增
        </button>
      </div>
    </div>
  </div>
</div>
{%endif%}

<style>
.related-item-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  transition: var(--transition);
}

.related-item-card:hover {
  border-color: var(--primary);
  background: var(--gray-50);
}

.related-item-card img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  border-radius: var(--radius-sm);
}

.related-item-card .info {
  flex: 1;
}

.related-item-card .name {
  font-weight: 600;
  color: var(--gray-800);
}

.related-item-card .type-badge {
  font-size: 0.7rem;
}

<style>
.item-detail-card {
  background: #fff;
  padding: 2rem;
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
}

.item-title {
  font-size: 2rem;
  font-weight: 800;
  color: var(--gray-800);
}

.info-sections {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.info-section {
  padding: 1.25rem;
  background: var(--gray-50);
  border-radius: var(--radius-md);
}

.info-section-title {
  font-weight: 700;
  font-size: 1rem;
  color: var(--gray-700);
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.photo-thumb {
  width: 60px;
  height: 60px;
  object-fit: cover;
  cursor: pointer;
  opacity: 0.6;
  transition: var(--transition);
  border: 2px solid transparent;
}

.photo-thumb:hover,
.photo-thumb.active {
  opacity: 1;
  border-color: var(--primary);
}

/* 時間軸樣式 */
.timeline {
  position: relative;
  padding-left: 2rem;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 8px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--gray-200);
}

.timeline-item {
  position: relative;
  padding-bottom: 1.5rem;
}

.timeline-item:last-child {
  padding-bottom: 0;
}

.timeline-marker {
  position: absolute;
  left: -2rem;
  top: 5px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  background: var(--primary);
  border: 2px solid #fff;
  box-shadow: 0 0 0 2px var(--primary);
}

@media (max-width: 991px) {
  .item-title {
    font-size: 1.5rem;
  }
  
  .item-detail-card {
    padding: 1.5rem;
  }
}
</style>
{%endblock%}

{%block js%}
<script>
function switchPhoto(src, thumbEl) {
  document.getElementById('mainPhoto').src = src;
  document.querySelectorAll('.photo-thumb').forEach(t => t.classList.remove('active'));
  thumbEl.classList.add('active');
}

// 載入關聯物品
async function loadRelatedItems() {
  const container = document.getElementById('relatedItemsContainer');
  const loading = document.getElementById('relatedLoading');
  
  try {
    const response = await fetch(`/api/related-items/{{item.ItemID}}`);
    const data = await response.json();
    
    if (data.success && data.related_items.length > 0) {
      container.innerHTML = `
        <div class="row g-3">
          ${data.related_items.map(item => `
            <div class="col-md-6">
              <div class="related-item-card">
                ${item.ItemPic 
                  ? `<img src="/uploads/${item.ItemThumb || item.ItemPic}" alt="${item.ItemName}">`
                  : `<div class="bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px; border-radius: 8px;"><i class="fas fa-image text-muted"></i></div>`
                }
                <div class="info">
                  <a href="/item/${item.ItemID}" class="name text-decoration-none">${item.ItemName}</a>
                  <div class="small text-muted">${item.ItemID}</div>
                </div>
                <span class="badge bg-info type-badge">${item.relation_type}</span>
                {%if User.admin%}
                <button type="button" class="btn btn-link btn-sm text-danger p-0" onclick="removeRelatedItem('${item.ItemID}')" title="移除關聯">
                  <i class="fas fa-times"></i>
                </button>
                {%endif%}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    } else {
      container.innerHTML = `
        <div class="text-center py-4 text-muted">
          <i class="fas fa-link fa-2x mb-2 opacity-50"></i>
          <p class="mb-0">尚無關聯物品</p>
          {%if User.admin%}
          <small>點擊「新增關聯」來建立物品間的關係</small>
          {%endif%}
        </div>
      `;
    }
  } catch (error) {
    container.innerHTML = `<div class="text-center text-muted py-3">載入失敗</div>`;
  }
}

{%if User.admin%}
async function addRelatedItem() {
  const relatedId = document.getElementById('relatedItemId').value.trim();
  const relationType = document.getElementById('relationType').value;
  
  if (!relatedId) {
    alert('請輸入物品 ID');
    return;
  }
  
  try {
    const response = await fetch(`/api/related-items/{{item.ItemID}}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ related_id: relatedId, type: relationType })
    });
    
    const data = await response.json();
    
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('addRelatedModal')).hide();
      document.getElementById('relatedItemId').value = '';
      loadRelatedItems();
    } else {
      alert(data.message || '新增失敗');
    }
  } catch (error) {
    alert('新增失敗');
  }
}

async function removeRelatedItem(relatedId) {
  if (!confirm('確定要移除此關聯？')) return;
  
  try {
    const response = await fetch(`/api/related-items/{{item.ItemID}}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ related_id: relatedId })
    });
    
    const data = await response.json();
    
    if (data.success) {
      loadRelatedItems();
    } else {
      alert(data.message || '移除失敗');
    }
  } catch (error) {
    alert('移除失敗');
  }
}
{%endif%}

// 頁面載入時載入關聯物品
document.addEventListener('DOMContentLoaded', loadRelatedItems);
</script>
{%endblock%}

