{%extends 'template.html' %}
{%block title%}æƒæç‰©å“ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp text-center">
    <h1>ğŸ“· æƒæ QR/æ¢ç¢¼</h1>
    <p class="lead">ä½¿ç”¨ç›¸æ©Ÿæƒæç‰©å“ä¸Šçš„ QR Code æˆ–æ¢ç¢¼ï¼Œå¿«é€Ÿæ‰¾åˆ°ç‰©å“è³‡è¨Š</p>
  </div>
  
  <!-- ä½¿ç”¨èªªæ˜ -->
  <div class="row justify-content-center mb-4 animate-fadeInUp stagger-1">
    <div class="col-lg-8">
      <div class="scan-guide">
        <h5 class="mb-3"><i class="fas fa-info-circle text-primary me-2"></i>ä½¿ç”¨èªªæ˜</h5>
        <div class="row g-3">
          <div class="col-md-4">
            <div class="guide-step">
              <div class="step-icon">
                <i class="fas fa-camera"></i>
              </div>
              <h6>1. å…è¨±ç›¸æ©Ÿ</h6>
              <p class="small text-muted mb-0">é¦–æ¬¡ä½¿ç”¨è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿ</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="guide-step">
              <div class="step-icon">
                <i class="fas fa-qrcode"></i>
              </div>
              <h6>2. å°æº–æ¢ç¢¼</h6>
              <p class="small text-muted mb-0">å°‡ç‰©å“çš„ QR Code æˆ–æ¢ç¢¼å°æº–æ¡†æ¡†</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="guide-step">
              <div class="step-icon">
                <i class="fas fa-search"></i>
              </div>
              <h6>3. è‡ªå‹•æœå°‹</h6>
              <p class="small text-muted mb-0">æƒææˆåŠŸå¾Œè‡ªå‹•è·³è½‰è‡³ç‰©å“è©³æƒ…</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{%endblock%}

{%block body%}
<div class="container mb-4">
  <div class="row justify-content-center">
    <div class="col-lg-6">
      <!-- æƒæå™¨å®¹å™¨ -->
      <div class="scan-container animate-fadeInUp stagger-2">
        <!-- æ¬Šé™è«‹æ±‚/éŒ¯èª¤æç¤ºå€åŸŸ -->
        <div id="permissionPrompt" class="permission-prompt">
          <i class="fas fa-camera fa-4x mb-3"></i>
          <h4>éœ€è¦ç›¸æ©Ÿæ¬Šé™</h4>
          <p class="text-muted">è«‹å…è¨±ç€è¦½å™¨å­˜å–æ‚¨çš„ç›¸æ©Ÿä»¥ä½¿ç”¨æƒæåŠŸèƒ½</p>
          <button type="button" class="btn btn-primary btn-lg" onclick="requestCameraPermission()">
            <i class="fas fa-unlock me-2"></i>å…è¨±ç›¸æ©Ÿå­˜å–
          </button>
        </div>
        
        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="error-message d-none">
          <i class="fas fa-exclamation-triangle fa-4x mb-3 text-warning"></i>
          <h4 id="errorTitle">ç„¡æ³•å­˜å–ç›¸æ©Ÿ</h4>
          <p id="errorDesc" class="text-muted">è«‹ç¢ºèªæ‚¨çš„è£ç½®æœ‰ç›¸æ©Ÿï¼Œä¸¦å…è¨±ç€è¦½å™¨å­˜å–ã€‚</p>
          <div class="d-flex flex-column gap-2 align-items-center">
            <button type="button" class="btn btn-outline-primary" onclick="retryCamera()">
              <i class="fas fa-redo me-1"></i>é‡è©¦
            </button>
            <a href="{{ url_for('items.search') }}" class="btn btn-link">
              <i class="fas fa-keyboard me-1"></i>æ”¹ç”¨æ‰‹å‹•æœå°‹
            </a>
          </div>
          <div class="mt-4 p-3 bg-light rounded text-start">
            <h6><i class="fas fa-lightbulb me-1"></i>ç–‘é›£æ’è§£</h6>
            <ul class="small text-muted mb-0">
              <li>ç¢ºèªæ‚¨çš„è£ç½®æœ‰å¯ç”¨çš„ç›¸æ©Ÿ</li>
              <li>æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æœ‰ç›¸æ©Ÿå­˜å–æ¬Šé™</li>
              <li>è‹¥ä½¿ç”¨æ¡Œæ©Ÿï¼Œå¯èƒ½éœ€è¦å¤–æ¥ Webcam</li>
              <li>å˜—è©¦ä½¿ç”¨ Chrome æˆ– Safari ç€è¦½å™¨</li>
            </ul>
          </div>
        </div>
        
        <!-- æƒæå™¨ -->
        <div id="reader" class="d-none"></div>
        
        <!-- æƒææˆåŠŸå‹•ç•« -->
        <div id="scanSuccess" class="scan-success d-none">
          <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
          <h4>æƒææˆåŠŸï¼</h4>
          <p class="text-muted">æ­£åœ¨è¼‰å…¥ç‰©å“è³‡è¨Š...</p>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
          </div>
        </div>
      </div>
      
      <!-- æ§åˆ¶æŒ‰éˆ• -->
      <div class="text-center mt-4">
        <div class="btn-group" id="scanControls" style="display: none;">
          <button id="btn-stop" class="btn btn-outline-secondary" disabled>
            <i class="fas fa-stop me-1"></i>åœæ­¢æƒæ
          </button>
          <button id="btn-switch" class="btn btn-outline-primary">
            <i class="fas fa-sync-alt me-1"></i>åˆ‡æ›ç›¸æ©Ÿ
          </button>
        </div>
      </div>
      
      <!-- æƒææ­·å² -->
      <div class="scan-history mt-4" id="scanHistory" style="display: none;">
        <h6><i class="fas fa-history me-2"></i>æœ€è¿‘æƒæ</h6>
        <ul class="list-group list-group-flush" id="historyList"></ul>
      </div>
    </div>
  </div>
</div>

<style>
.scan-guide {
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: var(--radius-lg);
  padding: 1.5rem;
}

.guide-step {
  text-align: center;
  padding: 1rem;
}

.step-icon {
  width: 60px;
  height: 60px;
  background: var(--gradient-primary);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 1rem;
  color: white;
  font-size: 1.5rem;
}

.scan-container {
  background: #000;
  border-radius: var(--radius-lg);
  overflow: hidden;
  min-height: 350px;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
}

.permission-prompt,
.error-message,
.scan-success {
  text-align: center;
  color: white;
  padding: 2rem;
}

.permission-prompt i,
.error-message i {
  opacity: 0.8;
}

#reader {
  width: 100%;
}

#reader video {
  border-radius: 0 !important;
}

.scan-history {
  background: var(--gray-50);
  border-radius: var(--radius-md);
  padding: 1rem;
}

.scan-history .list-group-item {
  background: transparent;
  border: none;
  padding: 0.5rem 0;
}

.scan-history .list-group-item + .list-group-item {
  border-top: 1px solid var(--gray-200);
}

/* æƒææ¡†å‹•ç•« */
@keyframes scanLine {
  0% { top: 0; }
  50% { top: calc(100% - 2px); }
  100% { top: 0; }
}

.scan-line {
  position: absolute;
  left: 10%;
  right: 10%;
  height: 2px;
  background: var(--primary);
  box-shadow: 0 0 10px var(--primary);
  animation: scanLine 2s ease-in-out infinite;
  z-index: 10;
}
</style>
{%endblock%}

{%block js%}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const readerElem = document.getElementById("reader");
  const stopBtn = document.getElementById("btn-stop");
  const switchBtn = document.getElementById("btn-switch");
  const scanControls = document.getElementById("scanControls");
  const permissionPrompt = document.getElementById("permissionPrompt");
  const errorMessage = document.getElementById("errorMessage");
  const scanSuccess = document.getElementById("scanSuccess");
  const historySection = document.getElementById("scanHistory");
  const historyList = document.getElementById("historyList");
  
  let html5Qrcode;
  let currentCamera = "environment"; // é è¨­å¾Œç½®ç›¸æ©Ÿ
  let scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');

  // é¡¯ç¤ºæƒææ­·å²
  function renderHistory() {
    if (scanHistory.length === 0) return;
    
    historySection.style.display = 'block';
    historyList.innerHTML = scanHistory.slice(0, 5).map(item => `
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <a href="{{ url_for('items.search') }}?q=${encodeURIComponent(item.code)}" class="text-decoration-none">
          <i class="fas fa-qrcode me-2 text-muted"></i>${item.code}
        </a>
        <small class="text-muted">${item.time}</small>
      </li>
    `).join('');
  }

  // æƒææˆåŠŸè™•ç†
  function onScanSuccess(decodedText) {
    // éœ‡å‹•åé¥‹ï¼ˆå¦‚æœè£ç½®æ”¯æ´ï¼‰
    if (navigator.vibrate) {
      navigator.vibrate(200);
    }
    
    // æ’­æ”¾æç¤ºéŸ³
    try {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdH+Onp6QfW1laHmHlZ+fjXdpZGd4iJadnIx1aGRoeIqXnJqJc2ViZniKl5yZiHJlYmZ4ipecmYhyZWJmeIqXnJmIcmViZniKl5yZiHJlYmZ4ipecmYhyZWJmeIqXnJmIcmViZg==');
      audio.play();
    } catch (e) {}
    
    // å„²å­˜åˆ°æ­·å²
    const now = new Date();
    scanHistory.unshift({
      code: decodedText,
      time: now.toLocaleTimeString()
    });
    scanHistory = scanHistory.slice(0, 10);
    localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
    
    // é¡¯ç¤ºæˆåŠŸå‹•ç•«
    readerElem.classList.add('d-none');
    scanSuccess.classList.remove('d-none');
    scanControls.style.display = 'none';
    
    // åœæ­¢æƒæå™¨
    if (html5Qrcode) {
      html5Qrcode.stop();
    }
    
    // è§£æå…§å®¹ä¸¦è·³è½‰
    setTimeout(() => {
      let itemId = decodedText.startsWith("item:") ? decodedText.substring(5) : decodedText;
      
      // æª¢æŸ¥æ˜¯å¦ç‚ºç‰©å“ ID æ ¼å¼ï¼ˆå˜—è©¦ç›´æ¥æŸ¥çœ‹ç‰©å“ï¼‰
      if (itemId.startsWith("ITEM-") || /^[A-Z0-9-]+$/i.test(itemId)) {
        window.location.href = "{{ url_for('items.search') }}?q=" + encodeURIComponent(itemId);
      } else {
        window.location.href = "{{ url_for('items.search') }}?q=" + encodeURIComponent(itemId);
      }
    }, 1000);
  }

  // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
  async function requestCameraPermission() {
    permissionPrompt.classList.add('d-none');
    
    try {
      // å…ˆå˜—è©¦å–å¾—æ¬Šé™
      await navigator.mediaDevices.getUserMedia({ video: true });
      startScanner();
    } catch (err) {
      showError(err);
    }
  }

  // é¡¯ç¤ºéŒ¯èª¤
  function showError(err) {
    permissionPrompt.classList.add('d-none');
    readerElem.classList.add('d-none');
    scanControls.style.display = 'none';
    errorMessage.classList.remove('d-none');
    
    const errorTitle = document.getElementById('errorTitle');
    const errorDesc = document.getElementById('errorDesc');
    
    if (err.name === 'NotAllowedError') {
      errorTitle.textContent = 'ç›¸æ©Ÿæ¬Šé™è¢«æ‹’çµ•';
      errorDesc.textContent = 'è«‹åœ¨ç€è¦½å™¨è¨­å®šä¸­å…è¨±æ­¤ç¶²ç«™å­˜å–ç›¸æ©Ÿã€‚';
    } else if (err.name === 'NotFoundError') {
      errorTitle.textContent = 'æ‰¾ä¸åˆ°ç›¸æ©Ÿ';
      errorDesc.textContent = 'æ‚¨çš„è£ç½®ä¼¼ä¹æ²’æœ‰å¯ç”¨çš„ç›¸æ©Ÿã€‚';
    } else if (err.name === 'NotReadableError') {
      errorTitle.textContent = 'ç›¸æ©Ÿè¢«ä½”ç”¨';
      errorDesc.textContent = 'ç›¸æ©Ÿå¯èƒ½æ­£è¢«å…¶ä»–æ‡‰ç”¨ç¨‹å¼ä½¿ç”¨ä¸­ã€‚';
    } else {
      errorTitle.textContent = 'ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ';
      errorDesc.textContent = err.message || 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚';
    }
  }

  // é‡è©¦
  function retryCamera() {
    errorMessage.classList.add('d-none');
    permissionPrompt.classList.remove('d-none');
  }

  // å•Ÿå‹•æƒæå™¨
  function startScanner() {
    html5Qrcode = new Html5Qrcode("reader");
    
    const config = { 
      fps: 10, 
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0
    };
    
    html5Qrcode.start(
      { facingMode: currentCamera },
      config,
      onScanSuccess,
      (error) => {} // éœé»˜è™•ç†æƒæéŒ¯èª¤
    ).then(() => {
      permissionPrompt.classList.add('d-none');
      errorMessage.classList.add('d-none');
      readerElem.classList.remove('d-none');
      scanControls.style.display = 'flex';
      stopBtn.disabled = false;
    }).catch(err => {
      showError(err);
    });
  }

  // åœæ­¢æƒæå™¨
  function stopScanner() {
    if (html5Qrcode) {
      html5Qrcode.stop().then(() => {
        stopBtn.disabled = true;
        permissionPrompt.classList.remove('d-none');
        readerElem.classList.add('d-none');
        scanControls.style.display = 'none';
      });
    }
  }

  // åˆ‡æ›ç›¸æ©Ÿ
  async function switchCamera() {
    if (html5Qrcode) {
      await html5Qrcode.stop();
      currentCamera = currentCamera === "environment" ? "user" : "environment";
      startScanner();
    }
  }

  // äº‹ä»¶ç¶å®š
  stopBtn.addEventListener("click", stopScanner);
  switchBtn.addEventListener("click", switchCamera);
  
  // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæ­·å²
  document.addEventListener("DOMContentLoaded", () => {
    renderHistory();
    
    // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç›¸æ©Ÿæ¬Šé™
    if (navigator.permissions) {
      navigator.permissions.query({ name: 'camera' }).then(result => {
        if (result.state === 'granted') {
          requestCameraPermission();
        }
      }).catch(() => {});
    }
  });
</script>
{%endblock%}
