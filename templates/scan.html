{%extends 'template.html' %}
{%block title%}æƒæç‰©å“ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container">
  <div class="row">
    <div class="col-12">
      <h1 class="display-6 text-center mb-4">ğŸ“· æƒæ QR/æ¢ç¢¼</h1>
      <p class="text-center text-muted">å…è¨±ç›¸æ©Ÿæ¬Šé™å¾Œï¼Œæƒæå³å¯è‡ªå‹•è·³è½‰æœå°‹æˆ–é¡¯ç¤ºçµæœã€‚</p>
    </div>
  </div>
</div>
{%endblock%}

{%block body%}
<div class="container mb-4">
  <div id="reader" style="width: 100%; max-width: 480px; margin: 0 auto;"></div>
  <div class="text-center mt-3">
    <button id="btn-stop" class="btn btn-outline-secondary btn-sm" disabled>åœæ­¢æƒæ</button>
  </div>
</div>
{%endblock%}

{%block js%}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  const readerElem = document.getElementById("reader");
  const stopBtn = document.getElementById("btn-stop");
  let html5Qrcode;

  function onScanSuccess(decodedText) {
    try {
      // å‡è¨­å…§å®¹ç‚º item:<ItemID> æˆ–ç›´æ¥æ˜¯ ID / æ–‡å­—
      let itemId = decodedText.startsWith("item:") ? decodedText.substring(5) : decodedText;
      const url = "{{ url_for('items.search') }}" + "?q=" + encodeURIComponent(itemId);
      window.location.href = url;
    } catch (e) {
      console.error(e);
    }
  }

  function startScanner() {
    html5Qrcode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: 250 };
    html5Qrcode.start(
      { facingMode: "environment" },
      config,
      onScanSuccess,
      (error) => {}
    ).then(() => {
      stopBtn.disabled = false;
    }).catch(err => {
      console.error(err);
      alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥æ¬Šé™ã€‚");
    });
  }

  function stopScanner() {
    if (html5Qrcode) {
      html5Qrcode.stop().then(() => {
        stopBtn.disabled = true;
      });
    }
  }

  stopBtn.addEventListener("click", stopScanner);
  document.addEventListener("DOMContentLoaded", startScanner);
</script>
{%endblock%}

