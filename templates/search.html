{%extends 'template.html' %}
{%block title%}æœå°‹ç‰©å“ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container-fluid">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <h1>ğŸ” æœå°‹ç‰©å“</h1>
    <p class="lead">å¿«é€Ÿæ‰¾åˆ°æ‚¨éœ€è¦çš„ç‰©å“</p>
  </div>

  <!-- æœå°‹è¡¨å–® -->
  <div class="search-form animate-fadeInUp stagger-1">
    <form action="{{ url_for('items.search') }}" method="GET" class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-font me-1"></i>ç‰©å“åç¨±
        </label>
        <div class="input-group">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="è¼¸å…¥åç¨±æœå°‹..."
            value="{{ query }}"
            autofocus
          />
        </div>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-map-marker-alt me-1"></i>åœ°é»
        </label>
        <input
          type="text"
          name="place"
          class="form-control"
          placeholder="æ”¾ç½®åœ°é»..."
          value="{{ place }}"
        />
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-tag me-1"></i>é¡å‹
        </label>
        <select name="type" class="form-select">
          <option value="">å…¨éƒ¨é¡å‹</option>
          {% for type in itemtype %}
          <option value="{{type.name}}" {% if selected_type==type.name %}selected{% endif %}>{{type.name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">æ¨“å±¤</label>
        <select name="floor" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for f in floors %}
          <option value="{{f}}" {% if request.args.get('floor','')==f %}selected{% endif %}>{{f}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">æˆ¿é–“</label>
        <select name="room" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for r in rooms %}
          <option value="{{r}}" {% if request.args.get('room','')==r %}selected{% endif %}>{{r}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">å€åŸŸ</label>
        <select name="zone" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for z in zones %}
          <option value="{{z}}" {% if request.args.get('zone','')==z %}selected{% endif %}>{{z}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2 flex-wrap">
        <select name="sort" class="form-select flex-grow-1" style="max-width: 150px;">
          <option value="">æ’åºæ–¹å¼</option>
          <option value="name" {% if selected_sort=='name' %}selected{% endif %}>åç¨±</option>
          <option value="warranty" {% if selected_sort=='warranty' %}selected{% endif %}>ä¿å›ºåˆ°æœŸ</option>
          <option value="usage" {% if selected_sort=='usage' %}selected{% endif %}>ä½¿ç”¨æœŸé™</option>
        </select>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-search me-1"></i>æœå°‹
        </button>
        <a href="{{ url_for('items.search') }}" class="btn btn-outline-secondary" data-tooltip="æ¸…é™¤ç¯©é¸">
          <i class="fas fa-times"></i>
        </a>
      </div>
    </form>
  </div>

  <!-- æœå°‹çµæœçµ±è¨ˆ -->
  {%if query or place or selected_type or request.args.get('floor') or request.args.get('room') or request.args.get('zone')%}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-4 animate-fadeInUp stagger-2">
    <h5 class="mb-0">
      <i class="fas fa-list me-2"></i>
      æœå°‹çµæœ 
      <span class="badge bg-primary">{{ pagination.total if pagination else items|length }} é …</span>
    </h5>
    
    <!-- ç›®å‰ç¯©é¸æ¢ä»¶ -->
    <div class="d-flex flex-wrap gap-1 ms-auto">
      {%if query%}
      <span class="badge bg-light text-dark border">
        <i class="fas fa-font me-1"></i>åç¨±ï¼š{{query}}
        <a href="{{ url_for('items.search', place=place, type=selected_type) }}" class="text-danger ms-1">Ã—</a>
      </span>
      {%endif%}
      {%if place%}
      <span class="badge bg-light text-dark border">
        <i class="fas fa-map-marker-alt me-1"></i>åœ°é»ï¼š{{place}}
        <a href="{{ url_for('items.search', q=query, type=selected_type) }}" class="text-danger ms-1">Ã—</a>
      </span>
      {%endif%}
      {%if selected_type%}
      <span class="badge bg-light text-dark border">
        <i class="fas fa-tag me-1"></i>é¡å‹ï¼š{{selected_type}}
        <a href="{{ url_for('items.search', q=query, place=place) }}" class="text-danger ms-1">Ã—</a>
      </span>
      {%endif%}
    </div>
  </div>
  {%endif%}
</div>
{%endblock%}

{%block card%}
{%if items%}
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
  {%for item in items%}
  <div class="col">
    <div class="card h-100">
      <!-- ç‰©å“åœ–ç‰‡ -->
      <div class="position-relative overflow-hidden" style="height: 180px;">
        {%if item.ItemPic%}
        <img
          src="{{ url_for('items.uploaded_file', filename=item.ItemPic) }}"
          class="card-img-top h-100 w-100"
          alt="{{ item.ItemName }}"
          style="object-fit: cover"
          loading="lazy"
        />
        {%else%}
        <div class="card-img-top bg-gradient d-flex align-items-center justify-content-center h-100" 
             style="background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);">
          <i class="fas fa-image fa-3x text-white opacity-50"></i>
        </div>
        {%endif%}
        
        <!-- ç‹€æ…‹æ¨™ç±¤ -->
        <div class="position-absolute top-0 end-0 p-2 d-flex flex-column gap-1">
          {% if item.WarrantyStatus=='expired' %}
          <span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i></span>
          {% elif item.WarrantyStatus=='near' %}
          <span class="badge bg-warning"><i class="fas fa-clock"></i></span>
          {% endif %}
        </div>
        
        {%if item.ItemType%}
        <div class="position-absolute bottom-0 start-0 p-2">
          <span class="badge bg-dark bg-opacity-75">{{item.ItemType}}</span>
        </div>
        {%endif%}
      </div>
      
      <!-- å¡ç‰‡å…§å®¹ -->
      <div class="card-body py-3">
        <h6 class="card-title text-truncate mb-1" title="{{item.ItemName}}">
          {{ item.ItemName|highlight(query) }}
        </h6>
        <p class="card-text text-muted small mb-2">
          <i class="fas fa-hashtag"></i> {{ item.ItemID|highlight(query) }}
        </p>
        
        {%if item.ItemStorePlace%}
        <p class="card-text small mb-1">
          <i class="fas fa-map-marker-alt text-danger"></i> {{ item.ItemStorePlace|highlight(place) }}
        </p>
        {%endif%}
        
        {%if item.ItemFloor or item.ItemRoom or item.ItemZone%}
        <p class="card-text small text-muted mb-0">
          {{item.ItemFloor}} {{item.ItemRoom}} {{item.ItemZone}}
        </p>
        {%endif%}
      </div>
      
      <!-- å¡ç‰‡åº•éƒ¨æ“ä½œ -->
      <div class="card-footer bg-transparent py-2">
        <div class="d-flex justify-content-between align-items-center">
          {%if User.admin%}
          <a href="{{ url_for('items.edititem', item_id=item.ItemID) }}" 
             class="btn btn-sm btn-outline-primary">
            <i class="fas fa-edit"></i> ç·¨è¼¯
          </a>
          {%else%}
          <span></span>
          {%endif%}
          <div class="btn-group btn-group-sm">
            <a href="{{ url_for('items.qrcode_image', item_id=item.ItemID) }}" 
               class="btn btn-outline-dark" data-tooltip="QR Code">
              <i class="fas fa-qrcode"></i>
            </a>
            <a href="{{ url_for('items.barcode_image', item_id=item.ItemID) }}" 
               class="btn btn-outline-dark" data-tooltip="æ¢ç¢¼">
              <i class="fas fa-barcode"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  {%endfor%}
</div>

{%elif query or place or selected_type%}
<div class="empty-state animate-fadeInUp">
  <i class="fas fa-search"></i>
  <h3>æ²’æœ‰æ‰¾åˆ°ç›¸é—œç‰©å“</h3>
  <p>è«‹å˜—è©¦å…¶ä»–é—œéµå­—æˆ–èª¿æ•´ç¯©é¸æ¢ä»¶</p>
  <div class="d-flex gap-2 justify-content-center flex-wrap">
    <a href="{{ url_for('items.search') }}" class="btn btn-outline-primary">
      <i class="fas fa-redo me-1"></i>æ¸…é™¤ç¯©é¸
    </a>
    {%if User.admin%}
    <a href="{{ url_for('items.additem') }}" class="btn btn-primary">
      <i class="fas fa-plus me-1"></i>æ–°å¢ç‰©å“
    </a>
    {%endif%}
  </div>
</div>

{%else%}
<div class="empty-state animate-fadeInUp">
  <i class="fas fa-search"></i>
  <h3>é–‹å§‹æœå°‹æ‚¨çš„ç‰©å“</h3>
  <p>åœ¨ä¸Šæ–¹è¼¸å…¥ç‰©å“åç¨±ã€ä½ç½®æˆ–é¸æ“‡ç¯©é¸æ¢ä»¶</p>
  <div class="mt-4">
    <h6 class="text-muted mb-3">å¿«é€Ÿæœå°‹å»ºè­°</h6>
    <div class="d-flex flex-wrap justify-content-center gap-2">
      {% for type in itemtype[:6] %}
      <a href="{{ url_for('items.search', type=type.name) }}" class="btn btn-outline-secondary btn-sm">
        <i class="fas fa-tag me-1"></i>{{type.name}}
      </a>
      {% endfor %}
    </div>
  </div>
</div>
{%endif%}
{%endblock%}

{%block page%}
{% include "partials/pagination.html" %}
{%endblock%}
