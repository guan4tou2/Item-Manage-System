<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="物品管理系統 - 輕鬆管理家中物品，記錄放置位置"
    />
    <meta name="author" content="物品管理系統" />
    <!-- PWA Settings -->
    <link rel="manifest" href="{{url_for('static', filename='manifest.json')}}" />
    <meta name="theme-color" content="#0d6efd" />
    <link rel="apple-touch-icon" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/svgs/solid/box-open.svg">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>{%block title%}{%endblock%}</title>

    <!-- Bootstrap CSS -->
    <link
      href="{{url_for('static',filename='css/bootstrap.min.css')}}"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Google Fonts - Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- 主要樣式 -->
    <link
      href="{{url_for('static',filename='css/main.css')}}"
      rel="stylesheet"
    />
    <!-- 導航列樣式 -->
    <link
      href="{{url_for('static',filename='css/navbar.css')}}"
      rel="stylesheet"
    />
  </head>

  <body>
    <main>
      <!-- 導航列 -->
      <nav
        class="navbar navbar-expand-lg navbar-dark"
        aria-label="物品管理系統導航"
      >
        <div class="container">
          <a class="navbar-brand" href="{{url_for('items.home')}}">
            <i class="fas fa-box-open me-2"></i>物品管理系統
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNavbar"
            aria-controls="mainNavbar"
            aria-expanded="false"
            aria-label="切換導航"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  href="{{url_for('items.home')}}"
                  data-tooltip="查看所有物品"
                >
                  <i class="fas fa-home me-1"></i>首頁
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{url_for('items.search')}}" data-tooltip="搜尋物品">
                  <i class="fas fa-search me-1"></i>搜尋
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{url_for('items.scan')}}" data-tooltip="掃描條碼或QR碼">
                  <i class="fas fa-qrcode me-1"></i>掃描
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{url_for('items.favorites')}}" data-tooltip="我的收藏">
                  <i class="fas fa-star me-1"></i>收藏
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{url_for('items.statistics')}}" data-tooltip="查看統計報表">
                  <i class="fas fa-chart-bar me-1"></i>統計
                </a>
              </li>
              {%if User.admin%}
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-cog me-1"></i>管理
                </a>
                <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                  <li>
                    <a class="dropdown-item" href="{{url_for('items.additem')}}">
                      <i class="fas fa-plus me-2 text-success"></i>新增物品
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('items.manageitem')}}">
                      <i class="fas fa-edit me-2 text-primary"></i>管理物品
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('items.print_labels')}}">
                      <i class="fas fa-print me-2 text-secondary"></i>列印標籤
                    </a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('types.addtype')}}">
                      <i class="fas fa-tags me-2 text-info"></i>新增類型
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('auth.admin_users')}}">
                      <i class="fas fa-users me-2 text-warning"></i>用戶管理
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('items.backup_page')}}">
                      <i class="fas fa-database me-2 text-secondary"></i>備份還原
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('locations.manage_locations')}}">
                      <i class="fas fa-map-marker-alt me-2 text-warning"></i>位置設定
                    </a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('items.activity_logs')}}">
                      <i class="fas fa-history me-2 text-secondary"></i>操作日誌
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('notifications.index')}}">
                      <i class="fas fa-bell me-2 text-primary"></i>通知設定
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="{{url_for('import.index')}}">
                      <i class="fas fa-file-import me-2 text-success"></i>批量導入
                    </a>
                  </li>
                </ul>
              </li>
              {%endif%}
            </ul>
            
            <!-- 搜尋框 -->
            <form
              role="search"
              class="col-12 col-lg-auto mb-3 mb-lg-0 me-lg-3"
              action="{{url_for('items.search')}}"
              method="GET"
            >
              <div class="input-group">
                <input
                  class="form-control"
                  type="search"
                  name="q"
                  id="navSearchInput"
                  placeholder="搜尋物品..."
                  aria-label="搜尋"
                />
                <button type="button" class="btn btn-outline-secondary d-none" id="navClearBtn" onclick="clearNavSearch()">
                  <i class="fas fa-times"></i>
                </button>
                <button class="btn btn-outline-light" type="submit">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </form>
            
                  <!-- 暗色模式切換 -->
                  <div class="nav-item me-2">
                    <button type="button" 
                            class="btn btn-link nav-link theme-toggle" 
                            id="themeToggle"
                            title="切換深色/淺色模式"
                            onclick="toggleTheme()">
                      <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                  </div>
                  
                  <!-- 通知鈴鐺 -->
                  <div class="nav-item me-3">
                    <a href="{{url_for('items.notifications')}}" 
                       class="nav-link position-relative notification-bell" 
                       id="notificationBell"
                       title="到期通知">
                      <i class="fas fa-bell fa-lg"></i>
                      <span class="notification-badge d-none" id="notificationBadge">0</span>
                    </a>
                  </div>
            
            <!-- 使用者選單 -->
            <div class="dropdown text-end">
              <a
                href="#"
                class="d-flex align-items-center link-light text-decoration-none dropdown-toggle"
                id="userDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <div class="user-avatar me-2">
                  <i class="fas fa-user"></i>
                </div>
                <span>{%block user%}{%endblock%}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown">
                <li class="dropdown-header">
                  <i class="fas fa-user-circle me-1"></i> 
                  {%if User.admin%}管理員{%else%}使用者{%endif%}
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{{url_for('items.home')}}">
                    <i class="fas fa-home me-2"></i>首頁
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="{{url_for('items.search')}}">
                    <i class="fas fa-search me-2"></i>搜尋物品
                  </a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" onclick="showGuide()">
                    <i class="fas fa-question-circle me-2"></i>操作指引
                  </a>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item text-danger" href="{{url_for('auth.signout')}}">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <!-- 主內容區 -->
      <div class="container-fluid py-4">
        {% include "partials/flash.html" %}

        <div class="bg-light p-4 p-md-5 rounded-4">
          <div class="mx-auto">
            {%block contain%}{%endblock%}
            {%block body%}{%endblock%}
            {%block card%}{%endblock%}
            {%block modal%}{%endblock%}
          </div>
        </div>
        
        <div class="mt-4">
          {%block page%}{%endblock%}
        </div>
      </div>

      <!-- 快速操作提示 -->
      <div class="quick-tip" id="quickTip">
        <i class="fas fa-lightbulb"></i>
        <span id="tipContent">提示：使用搜尋功能快速找到物品</span>
        <button class="close-tip" onclick="closeTip()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- 浮動操作按鈕 (管理員) -->
      {%if User.admin%}
      <a href="{{url_for('items.additem')}}" class="fab btn btn-primary" data-tooltip="新增物品">
        <i class="fas fa-plus"></i>
      </a>
      {%endif%}

      <!-- 操作指引覆蓋層 -->
      <div class="guide-overlay" id="guideOverlay"></div>
      
      <!-- 操作指引提示框 -->
      <div class="guide-tooltip" id="guideTooltip">
        <div class="guide-progress" id="guideProgress"></div>
        <h4 id="guideTitle">歡迎使用</h4>
        <p id="guideContent">讓我們開始了解系統功能吧！</p>
        <div class="guide-actions">
          <button class="btn btn-sm btn-outline-secondary" onclick="skipGuide()">跳過</button>
          <button class="btn btn-sm btn-primary" onclick="nextGuideStep()">下一步</button>
        </div>
      </div>
    </main>

    <!-- 幫助 Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h5 class="modal-title" id="helpModalLabel">
              <i class="fas fa-question-circle me-2"></i>操作指引
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-primary rounded-circle p-3">
                      <i class="fas fa-plus fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>新增物品</h5>
                    <p class="text-muted mb-0">點擊右下角的「+」按鈕或從管理選單中選擇「新增物品」，填寫物品資訊和照片即可。</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-info rounded-circle p-3">
                      <i class="fas fa-search fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>搜尋物品</h5>
                    <p class="text-muted mb-0">使用頂部搜尋欄或進入搜尋頁面，可依名稱、位置、類型等條件篩選。</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-success rounded-circle p-3">
                      <i class="fas fa-qrcode fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>掃描條碼</h5>
                    <p class="text-muted mb-0">進入掃描頁面，使用相機掃描物品的 QR Code 或條碼，快速查看詳情。</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-warning rounded-circle p-3">
                      <i class="fas fa-map-marker-alt fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>位置管理</h5>
                    <p class="text-muted mb-0">先在「位置設定」中建立樓層、房間、區域，方便記錄物品存放位置。</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-secondary rounded-circle p-3">
                      <i class="fas fa-tags fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>類型分類</h5>
                    <p class="text-muted mb-0">建立物品類型（如：電子產品、文具、工具等），方便分類管理。</p>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="d-flex align-items-start">
                  <div class="flex-shrink-0">
                    <span class="badge bg-danger rounded-circle p-3">
                      <i class="fas fa-clock fa-lg"></i>
                    </span>
                  </div>
                  <div class="flex-grow-1 ms-3">
                    <h5>到期提醒</h5>
                    <p class="text-muted mb-0">設定保固截止和使用期限，系統會自動標記即將到期或已過期的物品。</p>
                  </div>
                </div>
              </div>
            </div>
            
            <hr class="my-4">
            
            <h6 class="mb-3"><i class="fas fa-keyboard me-2"></i>快捷操作</h6>
            <div class="row g-2">
              <div class="col-auto">
                <span class="badge bg-light text-dark border">
                  <kbd>Ctrl</kbd> + <kbd>K</kbd> 快速搜尋
                </span>
              </div>
              <div class="col-auto">
                <span class="badge bg-light text-dark border">
                  <kbd>N</kbd> 新增物品
                </span>
              </div>
              <div class="col-auto">
                <span class="badge bg-light text-dark border">
                  <kbd>?</kbd> 顯示說明
                </span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            <button type="button" class="btn btn-primary" onclick="startGuide()">
              <i class="fas fa-play me-1"></i>開始導覽
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{{url_for('static',filename='js/bootstrap.bundle.min.js')}}"></script>
    
    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register("{{url_for('static', filename='sw.js')}}")
            .then(registration => {
              console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(err => {
              console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
    </script>
    
    <script>
      // ========================================
      // 暗色模式切換
      // ========================================
      function getStoredTheme() {
        return localStorage.getItem('theme');
      }
      
      function getPreferredTheme() {
        const storedTheme = getStoredTheme();
        if (storedTheme) {
          return storedTheme;
        }
        // 檢查系統偏好
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      }
      
      function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        updateThemeIcon(theme);
      }
      
      function updateThemeIcon(theme) {
        const icon = document.getElementById('themeIcon');
        if (icon) {
          if (theme === 'dark') {
            icon.classList.remove('fa-moon');
            icon.classList.add('fa-sun');
          } else {
            icon.classList.remove('fa-sun');
            icon.classList.add('fa-moon');
          }
        }
      }
      
      function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        setTheme(newTheme);
        
        // 切換動畫
        const btn = document.getElementById('themeToggle');
        if (btn) {
          btn.style.transform = 'rotate(360deg)';
          setTimeout(() => {
            btn.style.transform = '';
          }, 300);
        }
      }
      
      // 頁面載入時套用主題
      (function() {
        const theme = getPreferredTheme();
        setTheme(theme);
      })();
      
      // 監聽系統主題變更
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
        if (!getStoredTheme()) {
          setTheme(e.matches ? 'dark' : 'light');
        }
      });
    </script>
    
    <script>
      // 操作提示系統
      const tips = [
        '使用搜尋功能快速找到物品',
        '點擊卡片可以查看物品詳情',
        '設定保固期限，系統會提醒您到期',
        '使用 QR Code 方便識別物品',
        '可以依樓層、房間、區域篩選物品',
      ];
      
      let currentTip = 0;
      const tipElement = document.getElementById('quickTip');
      const tipContent = document.getElementById('tipContent');
      
      // 顯示隨機提示
      function showRandomTip() {
        const shown = localStorage.getItem('tipShown');
        if (shown) return;
        
        currentTip = Math.floor(Math.random() * tips.length);
        tipContent.textContent = '提示：' + tips[currentTip];
        
        setTimeout(() => {
          tipElement.classList.add('show');
        }, 2000);
        
        setTimeout(() => {
          closeTip();
        }, 10000);
      }
      
      function closeTip() {
        tipElement.classList.remove('show');
        localStorage.setItem('tipShown', 'true');
      }
      
      // 操作指引系統
      const guideSteps = [
        {
          title: '歡迎使用物品管理系統！',
          content: '這個系統幫助您記錄和追蹤家中物品的位置，再也不怕找不到東西。',
          target: null
        },
        {
          title: '首頁概覽',
          content: '在首頁可以看到所有物品的卡片視圖，包含照片、位置和基本資訊。',
          target: '.navbar-brand'
        },
        {
          title: '快速搜尋',
          content: '使用頂部搜尋欄快速找到您需要的物品，支援名稱和位置搜尋。',
          target: '.navbar form'
        },
        {
          title: '管理功能',
          content: '管理員可以新增、編輯、刪除物品，以及設定位置和類型選項。',
          target: '#adminDropdown'
        },
        {
          title: '新增物品',
          content: '點擊右下角的「+」按鈕快速新增物品，記得上傳照片方便識別！',
          target: '.fab'
        }
      ];
      
      let currentGuideStep = 0;
      const guideOverlay = document.getElementById('guideOverlay');
      const guideTooltip = document.getElementById('guideTooltip');
      const guideTitle = document.getElementById('guideTitle');
      const guideContent = document.getElementById('guideContent');
      const guideProgress = document.getElementById('guideProgress');
      
      function showGuide() {
        const helpModal = bootstrap.Modal.getInstance(document.getElementById('helpModal'));
        if (helpModal) helpModal.hide();
        
        new bootstrap.Modal(document.getElementById('helpModal')).show();
      }
      
      function startGuide() {
        const helpModal = bootstrap.Modal.getInstance(document.getElementById('helpModal'));
        if (helpModal) helpModal.hide();
        
        currentGuideStep = 0;
        showGuideStep();
      }
      
      function showGuideStep() {
        const step = guideSteps[currentGuideStep];
        
        // 更新進度指示器
        guideProgress.innerHTML = '';
        for (let i = 0; i < guideSteps.length; i++) {
          const dot = document.createElement('div');
          dot.className = 'guide-progress-dot' + (i === currentGuideStep ? ' active' : '');
          guideProgress.appendChild(dot);
        }
        
        // 更新內容
        guideTitle.textContent = step.title;
        guideContent.textContent = step.content;
        
        // 顯示覆蓋層和提示框
        guideOverlay.classList.add('active');
        guideTooltip.classList.add('active');
        
        // 定位提示框
        if (step.target) {
          const targetEl = document.querySelector(step.target);
          if (targetEl) {
            const rect = targetEl.getBoundingClientRect();
            guideTooltip.style.top = (rect.bottom + 20) + 'px';
            guideTooltip.style.left = Math.max(20, rect.left) + 'px';
            guideTooltip.className = 'guide-tooltip active bottom';
            
            // 高亮目標元素
            targetEl.style.position = 'relative';
            targetEl.style.zIndex = '9999';
            targetEl.style.background = 'white';
            targetEl.style.borderRadius = '8px';
            targetEl.style.padding = '8px';
          }
        } else {
          // 置中顯示
          guideTooltip.style.top = '50%';
          guideTooltip.style.left = '50%';
          guideTooltip.style.transform = 'translate(-50%, -50%)';
          guideTooltip.className = 'guide-tooltip active';
        }
        
        // 更新按鈕文字
        const nextBtn = guideTooltip.querySelector('.btn-primary');
        if (currentGuideStep === guideSteps.length - 1) {
          nextBtn.textContent = '完成';
        } else {
          nextBtn.textContent = '下一步';
        }
      }
      
      function nextGuideStep() {
        // 清除上一步的高亮
        document.querySelectorAll('[style*="z-index: 9999"]').forEach(el => {
          el.style.position = '';
          el.style.zIndex = '';
          el.style.background = '';
          el.style.borderRadius = '';
          el.style.padding = '';
        });
        
        currentGuideStep++;
        
        if (currentGuideStep >= guideSteps.length) {
          skipGuide();
          localStorage.setItem('guideCompleted', 'true');
        } else {
          showGuideStep();
        }
      }
      
      function skipGuide() {
        guideOverlay.classList.remove('active');
        guideTooltip.classList.remove('active');
        guideTooltip.style.transform = '';
        
        // 清除高亮
        document.querySelectorAll('[style*="z-index: 9999"]').forEach(el => {
          el.style.position = '';
          el.style.zIndex = '';
          el.style.background = '';
          el.style.borderRadius = '';
          el.style.padding = '';
        });
      }
      
      // 鍵盤快捷鍵
      const shortcuts = {
        'Ctrl+K / ⌘+K': '開啟搜尋',
        'N': '新增物品',
        'H': '返回首頁',
        'S': '進入搜尋頁',
        'F': '我的收藏',
        'T': '切換主題',
        '?': '顯示快捷鍵',
        'Esc': '關閉彈窗'
      };
      
      function showKeyboardShortcuts() {
        const modal = document.createElement('div');
        modal.id = 'shortcutsModal';
        modal.className = 'shortcuts-modal';
        modal.innerHTML = `
          <div class="shortcuts-content">
            <div class="shortcuts-header">
              <h5><i class="fas fa-keyboard me-2"></i>鍵盤快捷鍵</h5>
              <button type="button" onclick="closeShortcutsModal()">&times;</button>
            </div>
            <div class="shortcuts-body">
              ${Object.entries(shortcuts).map(([key, desc]) => `
                <div class="shortcut-item">
                  <kbd>${key}</kbd>
                  <span>${desc}</span>
                </div>
              `).join('')}
            </div>
            <div class="shortcuts-footer">
              <small class="text-muted">按 Esc 關閉此視窗</small>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
      }
      
      function closeShortcutsModal() {
        const modal = document.getElementById('shortcutsModal');
        if (modal) {
          modal.classList.remove('show');
          setTimeout(() => modal.remove(), 200);
        }
      }
      
      document.addEventListener('keydown', function(e) {
        const isTyping = ['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName);
        
        // Ctrl+K 或 Cmd+K 開啟搜尋
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          const searchInput = document.querySelector('.navbar input[type="search"]');
          if (searchInput) searchInput.focus();
          return;
        }
        
        // 輸入狀態下只處理 Escape
        if (isTyping) {
          if (e.key === 'Escape') {
            document.activeElement.blur();
          }
          return;
        }
        
        // ? 或 Shift+/ 顯示快捷鍵幫助
        if (e.key === '?' || (e.shiftKey && e.key === '/')) {
          e.preventDefault();
          const existing = document.getElementById('shortcutsModal');
          if (existing) {
            closeShortcutsModal();
          } else {
            showKeyboardShortcuts();
          }
          return;
        }
        
        // N 新增物品
        if (e.key === 'n' || e.key === 'N') {
          const fabBtn = document.querySelector('.fab');
          if (fabBtn) window.location.href = fabBtn.href;
          return;
        }
        
        // H 返回首頁
        if (e.key === 'h' || e.key === 'H') {
          window.location.href = '{{url_for("items.home")}}';
          return;
        }
        
        // S 搜尋頁
        if (e.key === 's' || e.key === 'S') {
          window.location.href = '{{url_for("items.search")}}';
          return;
        }
        
        // F 收藏頁
        if (e.key === 'f' || e.key === 'F') {
          window.location.href = '{{url_for("items.favorites")}}';
          return;
        }
        
        // T 切換主題
        if (e.key === 't' || e.key === 'T') {
          toggleTheme();
          return;
        }
        
        // ESC 關閉彈窗
        if (e.key === 'Escape') {
          closeShortcutsModal();
          skipGuide();
        }
      });
      
      // 首次訪問顯示提示
      document.addEventListener('DOMContentLoaded', function() {
        showRandomTip();
        
        // 首次使用顯示歡迎
        if (!localStorage.getItem('guideCompleted') && !localStorage.getItem('welcomeShown')) {
          localStorage.setItem('welcomeShown', 'true');
          setTimeout(() => {
            showGuide();
          }, 1000);
        }
      });
      
      // 點擊覆蓋層跳過
      guideOverlay.addEventListener('click', skipGuide);
      
      // 通知數量更新
      function updateNotificationBadge() {
        const badge = document.getElementById('notificationBadge');
        if (!badge) return;
        
        fetch('{{url_for("items.notification_count")}}')
          .then(response => response.json())
          .then(data => {
            const total = data.total || 0;
            if (total > 0) {
              badge.textContent = total > 99 ? '99+' : total;
              badge.classList.remove('d-none');
              
              // 如果有過期的，使用紅色；只有即將過期的使用黃色
              if (data.expired > 0) {
                badge.classList.remove('warning');
              } else {
                badge.classList.add('warning');
              }
            } else {
              badge.classList.add('d-none');
            }
          })
          .catch(err => console.log('無法載入通知數量'));
      }
      
      // ========================================
      // 圖片燈箱功能
      // ========================================
      let lightboxImages = [];
      let currentImageIndex = 0;
      
      function createLightbox() {
        if (document.getElementById('lightbox')) return;
        
        const lightbox = document.createElement('div');
        lightbox.id = 'lightbox';
        lightbox.className = 'lightbox';
        lightbox.innerHTML = `
          <div class="lightbox-content">
            <button type="button" class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <button type="button" class="lightbox-nav lightbox-prev" onclick="prevImage()">
              <i class="fas fa-chevron-left"></i>
            </button>
            <img src="" alt="放大圖片" id="lightboxImage">
            <button type="button" class="lightbox-nav lightbox-next" onclick="nextImage()">
              <i class="fas fa-chevron-right"></i>
            </button>
            <div class="lightbox-caption" id="lightboxCaption"></div>
          </div>
        `;
        document.body.appendChild(lightbox);
        
        // 點擊背景關閉
        lightbox.addEventListener('click', function(e) {
          if (e.target === lightbox) closeLightbox();
        });
      }
      
      function openLightbox(images, startIndex = 0, captions = []) {
        createLightbox();
        lightboxImages = Array.isArray(images) ? images : [images];
        currentImageIndex = startIndex;
        
        const lightbox = document.getElementById('lightbox');
        const img = document.getElementById('lightboxImage');
        const caption = document.getElementById('lightboxCaption');
        
        img.src = lightboxImages[currentImageIndex];
        caption.textContent = captions[currentImageIndex] || '';
        
        // 控制導航按鈕顯示
        const prevBtn = lightbox.querySelector('.lightbox-prev');
        const nextBtn = lightbox.querySelector('.lightbox-next');
        if (lightboxImages.length <= 1) {
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'none';
        } else {
          prevBtn.style.display = '';
          nextBtn.style.display = '';
        }
        
        setTimeout(() => lightbox.classList.add('show'), 10);
        document.body.style.overflow = 'hidden';
      }
      
      function closeLightbox() {
        const lightbox = document.getElementById('lightbox');
        if (lightbox) {
          lightbox.classList.remove('show');
          document.body.style.overflow = '';
        }
      }
      
      function prevImage() {
        currentImageIndex = (currentImageIndex - 1 + lightboxImages.length) % lightboxImages.length;
        document.getElementById('lightboxImage').src = lightboxImages[currentImageIndex];
      }
      
      function nextImage() {
        currentImageIndex = (currentImageIndex + 1) % lightboxImages.length;
        document.getElementById('lightboxImage').src = lightboxImages[currentImageIndex];
      }
      
      // 為所有物品圖片添加燈箱功能
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.card-img-top, .item-image, [data-lightbox]').forEach(img => {
          if (img.tagName === 'IMG' && img.src && !img.src.includes('data:')) {
            img.style.cursor = 'zoom-in';
            img.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              openLightbox(this.src, 0, [this.alt || '']);
            });
          }
        });
      });
      
      // 鍵盤控制燈箱
      document.addEventListener('keydown', function(e) {
        const lightbox = document.getElementById('lightbox');
        if (!lightbox || !lightbox.classList.contains('show')) return;
        
        if (e.key === 'ArrowLeft') prevImage();
        if (e.key === 'ArrowRight') nextImage();
        if (e.key === 'Escape') closeLightbox();
      });
      
      // ========================================
      // 搜尋自動完成
      // ========================================
      let searchTimeout = null;
      
      function initSearchAutocomplete() {
        const searchInput = document.querySelector('.navbar input[type="search"]');
        if (!searchInput) return;
        
        // 創建建議容器
        let suggestionsDiv = document.getElementById('searchSuggestions');
        if (!suggestionsDiv) {
          suggestionsDiv = document.createElement('div');
          suggestionsDiv.id = 'searchSuggestions';
          suggestionsDiv.className = 'search-suggestions';
          searchInput.parentElement.appendChild(suggestionsDiv);
        }
        
        searchInput.addEventListener('input', function() {
          const query = this.value.trim();
          
          clearTimeout(searchTimeout);
          
          if (query.length < 2) {
            suggestionsDiv.classList.remove('show');
            return;
          }
          
          searchTimeout = setTimeout(() => {
            fetch(`{{url_for("items.search_suggestions")}}?q=${encodeURIComponent(query)}`)
              .then(res => res.json())
              .then(data => {
                if (data.suggestions && data.suggestions.length > 0) {
                  renderSuggestions(data.suggestions, suggestionsDiv, searchInput);
                } else {
                  suggestionsDiv.classList.remove('show');
                }
              })
              .catch(err => console.log('搜尋建議載入失敗'));
          }, 200);
        });
        
        // 點擊外部關閉
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.search-suggestions') && e.target !== searchInput) {
            suggestionsDiv.classList.remove('show');
          }
        });
        
        // 鍵盤導航
        searchInput.addEventListener('keydown', function(e) {
          const items = suggestionsDiv.querySelectorAll('.suggestion-item');
          const active = suggestionsDiv.querySelector('.suggestion-item.active');
          let index = Array.from(items).indexOf(active);
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            index = (index + 1) % items.length;
            items.forEach((item, i) => item.classList.toggle('active', i === index));
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            index = (index - 1 + items.length) % items.length;
            items.forEach((item, i) => item.classList.toggle('active', i === index));
          } else if (e.key === 'Enter' && active) {
            e.preventDefault();
            active.click();
          }
        });
      }
      
      function renderSuggestions(suggestions, container, input) {
        container.innerHTML = suggestions.map((s, i) => `
          <div class="suggestion-item ${i === 0 ? 'active' : ''}" data-id="${s.id}">
            <div class="suggestion-icon">
              ${s.category === 'id' ? '<i class="fas fa-hashtag"></i>' : '<i class="fas fa-box"></i>'}
            </div>
            <div class="suggestion-content">
              <div class="suggestion-text">${s.text}</div>
              ${s.category === 'id' && s.name ? `<small class="text-muted">${s.name}</small>` : ''}
              ${s.category === 'name' ? `<small class="text-muted">${s.id}</small>` : ''}
            </div>
            ${s.type ? `<span class="badge bg-secondary">${s.type}</span>` : ''}
          </div>
        `).join('');
        
        container.classList.add('show');
        
        // 點擊建議項
        container.querySelectorAll('.suggestion-item').forEach(item => {
          item.addEventListener('click', function() {
            const id = this.dataset.id;
            window.location.href = `{{url_for("items.search")}}?q=${encodeURIComponent(id)}`;
          });
        });
      }
      
      // 頁面載入時更新通知
      document.addEventListener('DOMContentLoaded', function() {
        initSearchAutocomplete();
        updateNotificationBadge();
        
        // 每 5 分鐘自動更新一次
        setInterval(updateNotificationBadge, 5 * 60 * 1000);
        
        // 導航欄搜尋框清除功能
        const navSearchInput = document.getElementById('navSearchInput');
        const navClearBtn = document.getElementById('navClearBtn');
        
        if (navSearchInput && navClearBtn) {
          navSearchInput.addEventListener('input', function() {
            if (this.value) {
              navClearBtn.classList.remove('d-none');
            } else {
              navClearBtn.classList.add('d-none');
            }
          });
          
          navSearchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              clearNavSearch();
            }
          });
        }
      });
      
      function clearNavSearch() {
        const input = document.getElementById('navSearchInput');
        const btn = document.getElementById('navClearBtn');
        if (input) {
          input.value = '';
          input.focus();
        }
        if (btn) {
          btn.classList.add('d-none');
        }
      }
    </script>
    
    {%block js%}{%endblock%}
  </body>
</html>
