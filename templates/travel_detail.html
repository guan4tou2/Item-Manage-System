{%extends "template.html"%}
{%block title%}旅行管理 - {{travel.name}}{%endblock%}
{%block user%}{{User.name}}{%endblock%}
{%block contain%}
<div class="row mb-3">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <div>
      <h4 class="mb-1"><i class="fas fa-suitcase-rolling me-2"></i>{{travel.name}}</h4>
      <div class="text-muted small">{{travel.start_date or ''}}{% if travel.end_date %} - {{travel.end_date}}{% endif %}</div>
    </div>
    <div>
      <a class="btn btn-outline-secondary" href="{{ url_for('travel.list_page') }}">返回列表</a>
      <a class="btn btn-outline-primary" href="{{ url_for('travel.export_travel', travel_id=travel.id) }}">匯出 CSV</a>
    </div>
  </div>
</div>
<div class="row g-3">
  <div class="col-md-4">
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h6 class="card-title">新增群組</h6>
        <form method="post" action="{{ url_for('travel.add_group_form', travel_id=travel.id) }}">
          <div class="mb-2">
            <label class="form-label">群組名稱</label>
            <input type="text" name="name" class="form-control" placeholder="隨身、托運..." />
          </div>
          <div class="mb-3">
            <label class="form-label">排序</label>
            <input type="number" name="sort_order" class="form-control" value="0" />
          </div>
          <button type="submit" class="btn btn-primary btn-sm">新增群組</button>
        </form>
      </div>
    </div>
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="card-title">新增物品（含臨時）</h6>
        <form method="post" action="{{ url_for('travel.add_item_form', travel_id=travel.id) }}">
          <div class="mb-2">
            <label class="form-label">名稱</label>
            <input type="text" name="name" class="form-control" required />
          </div>
          <div class="mb-2">
            <label class="form-label">群組</label>
            <select name="group_id" class="form-select">
              <option value="">未分組</option>
              {% for g in groups %}
              <option value="{{g.id}}">{{g.name}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="row g-2 mb-2">
            <div class="col">
              <label class="form-label">應帶</label>
              <input type="number" name="qty_required" class="form-control" value="1" min="0" />
            </div>
            <div class="col">
              <label class="form-label">已打包</label>
              <input type="number" name="qty_packed" class="form-control" value="0" min="0" />
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">來源（選填）</label>
            <input type="text" name="source_ref" class="form-control" placeholder="庫存ID 或 留空為臨時" />
            <input type="hidden" name="source_type" value="temp" />
          </div>
          <div class="mb-3">
            <label class="form-label">備註</label>
            <textarea name="note" class="form-control" rows="2"></textarea>
          </div>
          <button type="submit" class="btn btn-primary btn-sm">新增物品</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-pack" type="button" role="tab">打包清單</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-shop" type="button" role="tab">購買清單</button>
      </li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-pack" role="tabpanel">
        {% for g in groups %}
        <div class="card mb-3 shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div><i class="fas fa-layer-group me-1"></i>{{g.name}}</div>
            <span class="text-muted small">排序 {{g.sort_order}}</span>
          </div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0 align-middle">
              <thead>
                <tr>
                  <th>攜帶</th>
                  <th>名稱</th>
                  <th class="text-center">已打包 / 應帶</th>
                  <th>備註</th>
                </tr>
              </thead>
              <tbody>
                {% for it in items if it.group_id==g.id %}
                <tr>
                  <td style="width:60px">
                    <form method="post" action="{{ url_for('travel.update_item_form', item_id=it.id, travel_id=travel.id) }}" class="d-inline">
                      <input type="hidden" name="toggle_carried" value="1" />
                      <button class="btn btn-sm {% if it.carried %}btn-success{%else%}btn-outline-secondary{%endif%}" type="submit" title="切換攜帶">
                        <i class="fas fa-check"></i>
                      </button>
                    </form>
                  </td>
                  <td>{{it.name}}</td>
                  <td class="text-center">
                    <form method="post" action="{{ url_for('travel.update_item_form', item_id=it.id, travel_id=travel.id) }}" class="d-flex justify-content-center align-items-center gap-1">
                      <input type="number" name="qty_packed" value="{{it.qty_packed}}" min="0" class="form-control form-control-sm" style="width:80px" />
                      <span class="text-muted">/</span>
                      <input type="number" name="qty_required" value="{{it.qty_required}}" min="0" class="form-control form-control-sm" style="width:80px" />
                      <button class="btn btn-sm btn-outline-primary" type="submit" title="更新數量"><i class="fas fa-save"></i></button>
                    </form>
                  </td>
                  <td class="text-muted small">
                    {{it.note or ''}}
                    <form method="post" action="{{ url_for('travel.delete_item_form', item_id=it.id, travel_id=travel.id) }}" class="d-inline float-end" onsubmit="return confirm('確定刪除此物品？');">
                      <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fas fa-trash"></i></button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
                {% if (items|selectattr('group_id','equalto',g.id)|list)|length == 0 %}
                <tr><td colspan="4" class="text-center text-muted small">目前沒有物品</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="tab-pane fade" id="tab-shop" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">購買清單</h6>
          <a class="btn btn-sm btn-outline-primary" href="{{ url_for('shopping.export_shopping', list_id=shopping.id) }}">匯出 CSV</a>
        </div>
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>狀態</th>
              <th>名稱</th>
              <th>數量</th>
              <th>預算</th>
              <th>店家/連結</th>
            </tr>
          </thead>
          <tbody>
            {% for si in shopping_items %}
            <tr>
              <td>{{si.status}}</td>
              <td>{{si.name}}</td>
              <td>{{si.qty}}</td>
              <td>{{si.budget or ''}}</td>
              <td class="small">{{si.store or ''}} {% if si.link %}<a href="{{si.link}}" target="_blank">連結</a>{% endif %}</td>
            </tr>
            {% endfor %}
            {% if shopping_items|length == 0 %}
            <tr><td colspan="5" class="text-center text-muted small">目前無項目</td></tr>
            {% endif %}
          </tbody>
        </table>
        <form method="post" action="{{ url_for('shopping.add_shopping_item', list_id=shopping.id) }}" class="mt-3">
          <div class="row g-2">
            <div class="col-md-4"><input name="name" class="form-control" placeholder="品名" required></div>
            <div class="col-md-2"><input name="qty" type="number" class="form-control" value="1" min="1"></div>
            <div class="col-md-2"><input name="budget" class="form-control" placeholder="預算"></div>
            <div class="col-md-4"><input name="store" class="form-control" placeholder="店家/連結"></div>
          </div>
          <div class="mt-2"><button class="btn btn-primary btn-sm">新增</button></div>
        </form>
      </div>
    </div>
  </div>
</div>
{%endblock%}
