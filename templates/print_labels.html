{%extends 'template.html' %}
{%block title%}åˆ—å° QR æ¨™ç±¤ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container-fluid">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <h1>ğŸ·ï¸ åˆ—å° QR æ¨™ç±¤</h1>
    <p class="lead">é¸æ“‡ç‰©å“ï¼Œæ‰¹é‡ç”Ÿæˆå¯åˆ—å°çš„ QR Code æ¨™ç±¤</p>
  </div>
  
  <!-- ä½¿ç”¨èªªæ˜ -->
  <div class="alert alert-info alert-dismissible fade show mb-4 animate-fadeInUp stagger-1" role="alert">
    <div class="d-flex align-items-start">
      <i class="fas fa-info-circle fa-2x me-3 mt-1"></i>
      <div>
        <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>
        <ol class="mb-0 mt-2">
          <li>å‹¾é¸è¦åˆ—å°çš„ç‰©å“ï¼ˆå¯å¤šé¸ï¼‰</li>
          <li>è¨­å®šæ¨™ç±¤æ¨£å¼å’Œé¡¯ç¤ºå…§å®¹</li>
          <li>é»æ“Šã€Œç”¢ç”Ÿæ¨™ç±¤ã€é è¦½</li>
          <li>ä½¿ç”¨ç€è¦½å™¨åˆ—å°åŠŸèƒ½ (Ctrl+P) åˆ—å°æ¨™ç±¤</li>
        </ol>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="é—œé–‰"></button>
  </div>
</div>
{%endblock%}

{%block body%}
<div class="container-fluid">
  <form method="POST" id="printForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <input type="hidden" name="item_ids" id="selectedItemIds"/>
    
    <div class="row">
      <!-- å·¦å´ï¼šç‰©å“é¸æ“‡ -->
      <div class="col-lg-8">
        <div class="card mb-4 animate-fadeInUp stagger-2">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>é¸æ“‡ç‰©å“</h5>
            <div class="btn-group btn-group-sm">
              <button type="button" class="btn btn-outline-primary" onclick="selectAll()">
                <i class="fas fa-check-double me-1"></i>å…¨é¸
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="deselectAll()">
                <i class="fas fa-times me-1"></i>å–æ¶ˆå…¨é¸
              </button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 50px;">
                      <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                    </th>
                    <th style="width: 80px;">åœ–ç‰‡</th>
                    <th>åç¨±</th>
                    <th>ID</th>
                    <th>ä½ç½®</th>
                    <th>é¡å‹</th>
                  </tr>
                </thead>
                <tbody>
                  {%for item in items%}
                  <tr class="item-row" data-item-id="{{item.ItemID}}">
                    <td>
                      <input type="checkbox" class="form-check-input item-checkbox" 
                             value="{{item.ItemID}}" onchange="updateSelection()">
                    </td>
                    <td>
                      {%if item.ItemPic%}
                      <img src="{{ url_for('items.uploaded_file', filename=item.ItemThumb or item.ItemPic) }}" 
                           alt="{{item.ItemName}}"
                           class="rounded"
                           style="width: 50px; height: 50px; object-fit: cover;">
                      {%else%}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center"
                           style="width: 50px; height: 50px;">
                        <i class="fas fa-image text-muted"></i>
                      </div>
                      {%endif%}
                    </td>
                    <td>
                      <strong>{{item.ItemName}}</strong>
                    </td>
                    <td>
                      <code class="small">{{item.ItemID}}</code>
                    </td>
                    <td>
                      <small class="text-muted">
                        {%if item.ItemStorePlace%}{{item.ItemStorePlace}}{%endif%}
                        {%if item.ItemFloor%}<br>{{item.ItemFloor}} {{item.ItemRoom}} {{item.ItemZone}}{%endif%}
                      </small>
                    </td>
                    <td>
                      {%if item.ItemType%}
                      <span class="badge bg-secondary">{{item.ItemType}}</span>
                      {%endif%}
                    </td>
                  </tr>
                  {%endfor%}
                </tbody>
              </table>
            </div>
            
            {%if not items%}
            <div class="text-center py-5">
              <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
              <p class="text-muted">æ²’æœ‰å¯é¸æ“‡çš„ç‰©å“</p>
              <a href="{{ url_for('items.additem') }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>æ–°å¢ç‰©å“
              </a>
            </div>
            {%endif%}
          </div>
          
          {%if items%}
          <div class="card-footer">
            {% include "partials/pagination.html" %}
          </div>
          {%endif%}
        </div>
      </div>
      
      <!-- å³å´ï¼šè¨­å®šé¢æ¿ -->
      <div class="col-lg-4">
        <div class="card sticky-top animate-fadeInUp stagger-3" style="top: 100px;">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>æ¨™ç±¤è¨­å®š</h5>
          </div>
          <div class="card-body">
            <!-- å·²é¸æ•¸é‡ -->
            <div class="alert alert-primary d-flex align-items-center mb-4">
              <i class="fas fa-check-circle fa-2x me-3"></i>
              <div>
                <strong>å·²é¸æ“‡ <span id="selectedCount">0</span> å€‹ç‰©å“</strong>
                <div class="small">å°‡ç”¢ç”Ÿå°æ‡‰æ•¸é‡çš„æ¨™ç±¤</div>
              </div>
            </div>
            
            <!-- æ¨™ç±¤å°ºå¯¸ -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="fas fa-ruler me-1"></i>æ¨™ç±¤å°ºå¯¸
              </label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="label_size" id="sizeSmall" value="small">
                <label class="btn btn-outline-primary" for="sizeSmall">
                  <i class="fas fa-compress me-1"></i>å°
                </label>
                
                <input type="radio" class="btn-check" name="label_size" id="sizeMedium" value="medium" checked>
                <label class="btn btn-outline-primary" for="sizeMedium">
                  <i class="fas fa-arrows-alt me-1"></i>ä¸­
                </label>
                
                <input type="radio" class="btn-check" name="label_size" id="sizeLarge" value="large">
                <label class="btn btn-outline-primary" for="sizeLarge">
                  <i class="fas fa-expand me-1"></i>å¤§
                </label>
              </div>
              <small class="text-muted d-block mt-1">
                å°ï¼š30Ã—30mm | ä¸­ï¼š50Ã—50mm | å¤§ï¼š70Ã—70mm
              </small>
            </div>
            
            <!-- é¡¯ç¤ºå…§å®¹ -->
            <div class="mb-4">
              <label class="form-label fw-bold">
                <i class="fas fa-eye me-1"></i>é¡¯ç¤ºå…§å®¹
              </label>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" name="show_name" id="showName" checked>
                <label class="form-check-label" for="showName">
                  ç‰©å“åç¨±
                </label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" name="show_id" id="showId" checked>
                <label class="form-check-label" for="showId">
                  ç‰©å“ ID
                </label>
              </div>
              <div class="form-check">
                <input type="checkbox" class="form-check-input" name="show_location" id="showLocation">
                <label class="form-check-label" for="showLocation">
                  æ”¾ç½®ä½ç½®
                </label>
              </div>
            </div>
            
            <!-- ç”¢ç”ŸæŒ‰éˆ• -->
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary btn-lg" id="generateBtn" disabled>
                <i class="fas fa-print me-2"></i>ç”¢ç”Ÿæ¨™ç±¤
              </button>
              <a href="{{ url_for('items.manageitem') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>è¿”å›ç®¡ç†
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{%endblock%}

{%block js%}
<script>
const checkboxes = document.querySelectorAll('.item-checkbox');
const selectedCountEl = document.getElementById('selectedCount');
const selectedItemIdsEl = document.getElementById('selectedItemIds');
const generateBtn = document.getElementById('generateBtn');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');

function updateSelection() {
  const selected = Array.from(checkboxes).filter(cb => cb.checked);
  const count = selected.length;
  
  selectedCountEl.textContent = count;
  selectedItemIdsEl.value = selected.map(cb => cb.value).join(',');
  generateBtn.disabled = count === 0;
  
  // æ›´æ–°å…¨é¸ç‹€æ…‹
  selectAllCheckbox.checked = count === checkboxes.length && count > 0;
  selectAllCheckbox.indeterminate = count > 0 && count < checkboxes.length;
}

function selectAll() {
  checkboxes.forEach(cb => cb.checked = true);
  updateSelection();
}

function deselectAll() {
  checkboxes.forEach(cb => cb.checked = false);
  updateSelection();
}

function toggleSelectAll(master) {
  checkboxes.forEach(cb => cb.checked = master.checked);
  updateSelection();
}

// é»æ“Šè¡Œé¸æ“‡
document.querySelectorAll('.item-row').forEach(row => {
  row.addEventListener('click', (e) => {
    if (e.target.type !== 'checkbox') {
      const checkbox = row.querySelector('.item-checkbox');
      checkbox.checked = !checkbox.checked;
      updateSelection();
    }
  });
});

// åˆå§‹åŒ–
updateSelection();
</script>
{%endblock%}

