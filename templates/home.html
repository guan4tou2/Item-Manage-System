{%extends 'template.html' %}
{%block title%}é¦–é  - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container-fluid">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <h1>ğŸ  æˆ‘çš„ç‰©å“ç®¡ç†</h1>
    <p class="lead">è¼•é¬†è¨˜éŒ„å®¶ä¸­ç‰©å“ä½ç½®ï¼Œå†ä¹Ÿä¸æ€•æ‰¾ä¸åˆ°æ±è¥¿ï¼</p>
  </div>

  <!-- å¿«é€Ÿå…¥é–€æŒ‡å¼• (é¦–æ¬¡ä½¿ç”¨è€…æˆ–ç‰©å“ç‚ºç©ºæ™‚é¡¯ç¤º) -->
  {%if not items%}
  <div class="quick-start animate-fadeInUp stagger-1">
    <h3><i class="fas fa-rocket text-primary"></i> å¿«é€Ÿé–‹å§‹</h3>
    <div class="quick-start-steps">
      <a href="{{url_for('locations.manage_locations')}}" class="quick-start-step text-decoration-none">
        <div class="step-number">1</div>
        <div class="step-content">
          <h4>è¨­å®šä½ç½®</h4>
          <p>å»ºç«‹æ¨“å±¤ã€æˆ¿é–“ã€å€åŸŸç­‰ä½ç½®é¸é …</p>
        </div>
      </a>
      <a href="{{url_for('types.addtype')}}" class="quick-start-step text-decoration-none">
        <div class="step-number">2</div>
        <div class="step-content">
          <h4>å»ºç«‹é¡å‹</h4>
          <p>æ–°å¢ç‰©å“åˆ†é¡ï¼Œå¦‚é›»å­ç”¢å“ã€æ–‡å…·ç­‰</p>
        </div>
      </a>
      <a href="{{url_for('items.additem')}}" class="quick-start-step text-decoration-none">
        <div class="step-number">3</div>
        <div class="step-content">
          <h4>æ–°å¢ç‰©å“</h4>
          <p>æ‹ç…§ä¸¦è¨˜éŒ„ç‰©å“è³‡è¨Šå’Œæ”¾ç½®ä½ç½®</p>
        </div>
      </a>
      <a href="{{url_for('items.search')}}" class="quick-start-step text-decoration-none">
        <div class="step-number">4</div>
        <div class="step-content">
          <h4>é–‹å§‹ä½¿ç”¨</h4>
          <p>æœå°‹ç‰©å“ï¼Œå¿«é€Ÿæ‰¾åˆ°æ‚¨éœ€è¦çš„æ±è¥¿</p>
        </div>
      </a>
    </div>
  </div>
  {%endif%}

  <!-- æœå°‹åŠŸèƒ½ -->
  <div class="search-form animate-fadeInUp stagger-2 mb-4">
    <form action="{{ url_for('items.search') }}" method="GET" id="searchForm">
      <div class="d-flex gap-2">
        <div class="flex-grow-1 position-relative">
          <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
          <input
            type="text"
            name="q"
            class="form-control form-control-lg ps-5 rounded-pill"
            placeholder="æœå°‹ç‰©å“åç¨±ã€æè¿°æˆ– ID..."
            value="{{ request.args.get('q', '') }}"
            id="homeSearchInput"
          />
          <button type="button" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2 text-decoration-none text-muted {% if not request.args.get('q', '') %}d-none{% endif %}" id="homeClearBtn" onclick="clearHomeSearch()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <button type="button" class="btn btn-outline-secondary rounded-pill px-3 position-relative" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
          <i class="fas fa-filter"></i> ç¯©é¸
          {% if request.args.get('type') or request.args.get('place') or request.args.get('floor') or request.args.get('room') or request.args.get('zone') %}
          <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle">
            <span class="visually-hidden">å·²å¥—ç”¨ç¯©é¸</span>
          </span>
          {% endif %}
        </button>
        
        <a href="{{ url_for('items.scan') }}" class="btn btn-primary rounded-circle" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;" data-tooltip="æƒææ¢ç¢¼">
          <i class="fas fa-qrcode"></i>
        </a>
      </div>

      <!-- ç¯©é¸ Offcanvas -->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title" id="filterOffcanvasLabel">
            <i class="fas fa-sliders-h me-2"></i>é€²éšç¯©é¸
          </h5>
          <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <!-- åœ°é» -->
          <div class="mb-3">
            <label class="form-label fw-bold">åœ°é»é—œéµå­—</label>
            <input type="text" name="place" class="form-control" placeholder="ä¾‹å¦‚ï¼šæŠ½å±œã€æ«ƒå­" value="{{ request.args.get('place', '') }}">
          </div>
          
          <!-- é¡å‹ -->
          <div class="mb-3">
            <label class="form-label fw-bold">ç‰©å“é¡å‹</label>
            <select name="type" class="form-select">
              <option value="">å…¨éƒ¨é¡å‹</option>
              {% for type in itemtype %}
              <option value="{{type.name}}" {% if request.args.get('type','')==type.name %}selected{% endif %}>{{type.name}}</option>
              {% endfor %}
            </select>
          </div>
          
          <hr>
          
          <!-- è©³ç´°ä½ç½® -->
          <h6 class="fw-bold mb-3">è©³ç´°ä½ç½®</h6>
          <div class="mb-3">
            <label class="form-label small text-muted">æ¨“å±¤</label>
            <select name="floor" class="form-select">
              <option value="">å…¨éƒ¨</option>
              {% for f in floors %}
              <option value="{{f}}" {% if request.args.get('floor','')==f %}selected{% endif %}>{{f}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small text-muted">æˆ¿é–“</label>
            <select name="room" class="form-select">
              <option value="">å…¨éƒ¨</option>
              {% for r in rooms %}
              <option value="{{r}}" {% if request.args.get('room','')==r %}selected{% endif %}>{{r}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label small text-muted">å€åŸŸ</label>
            <select name="zone" class="form-select">
              <option value="">å…¨éƒ¨</option>
              {% for z in zones %}
              <option value="{{z}}" {% if request.args.get('zone','')==z %}selected{% endif %}>{{z}}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="d-grid gap-2 mt-4">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-check me-1"></i>å¥—ç”¨ç¯©é¸
            </button>
            <a href="{{ url_for('items.home') }}" class="btn btn-outline-secondary">
              <i class="fas fa-undo me-1"></i>æ¸…é™¤é‡ç½®
            </a>
          </div>
        </div>
      </div>
    </form>
  </div>
    <form action="{{ url_for('items.search') }}" method="GET" class="row g-3 align-items-end">
      <div class="col-12 col-md-3">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-font me-1"></i>ç‰©å“åç¨±
        </label>
        <div class="input-group">
          <input
            type="text"
            name="q"
            id="homeSearchInput"
            class="form-control"
            placeholder="è¼¸å…¥åç¨±æœå°‹..."
            value="{{ request.args.get('q', '') }}"
          />
          <button type="button" class="btn btn-outline-secondary clear-input-btn {% if not request.args.get('q', '') %}d-none{% endif %}" id="homeClearBtn" onclick="clearHomeSearch()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-map-marker-alt me-1"></i>åœ°é»
        </label>
        <input
          type="text"
          name="place"
          class="form-control"
          placeholder="æ”¾ç½®åœ°é»..."
          value="{{ request.args.get('place', '') }}"
        />
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">
          <i class="fas fa-tag me-1"></i>é¡å‹
        </label>
        <select name="type" class="form-select">
          <option value="">å…¨éƒ¨é¡å‹</option>
          {% for type in itemtype %}
          <option value="{{type.name}}" {% if request.args.get('type','')==type.name %}selected{% endif %}>{{type.name}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">æ¨“å±¤</label>
        <select name="floor" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for f in floors %}
          <option value="{{f}}" {% if request.args.get('floor','')==f %}selected{% endif %}>{{f}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">æˆ¿é–“</label>
        <select name="room" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for r in rooms %}
          <option value="{{r}}" {% if request.args.get('room','')==r %}selected{% endif %}>{{r}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-4 col-md-1">
        <label class="form-label small text-muted mb-1">å€åŸŸ</label>
        <select name="zone" class="form-select">
          <option value="">å…¨éƒ¨</option>
          {% for z in zones %}
          <option value="{{z}}" {% if request.args.get('zone','')==z %}selected{% endif %}>{{z}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">
          <i class="fas fa-search me-1"></i>æœå°‹
        </button>
        <a href="{{ url_for('items.scan') }}" class="btn btn-outline-info" data-tooltip="æƒææ¢ç¢¼">
          <i class="fas fa-qrcode"></i>
        </a>
      </div>
    </form>
  </div>

  <!-- çµ±è¨ˆè³‡è¨Š -->
  <div class="row g-3 mb-4 animate-fadeInUp stagger-3">
    <div class="col-6 col-md-2">
      <div class="stats-card bg-primary text-white">
        <div class="icon"><i class="fas fa-box"></i></div>
        <h2>{{ stats.total if stats else (pagination.total if pagination else items|length) }}</h2>
        <h5>ç¸½ç‰©å“æ•¸</h5>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="stats-card bg-success text-white">
        <div class="icon"><i class="fas fa-image"></i></div>
        <h2>{{ stats.with_photo if stats else 0 }}</h2>
        <h5>æœ‰ç…§ç‰‡</h5>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="stats-card bg-info text-white">
        <div class="icon"><i class="fas fa-map-pin"></i></div>
        <h2>{{ stats.with_location if stats else 0 }}</h2>
        <h5>æœ‰ä½ç½®è¨˜éŒ„</h5>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <div class="stats-card bg-warning text-white">
        <div class="icon"><i class="fas fa-folder"></i></div>
        <h2>{{ stats.with_type if stats else 0 }}</h2>
        <h5>æœ‰åˆ†é¡</h5>
      </div>
    </div>
    <div class="col-6 col-md-2">
      <a href="{{ url_for('items.reorder_list') }}" class="text-decoration-none">
        <div class="stats-card bg-danger text-white" id="stockAlertCard">
          <div class="icon"><i class="fas fa-shopping-cart"></i></div>
          <h2 id="stockAlertCount">-</h2>
          <h5>éœ€è£œè²¨</h5>
        </div>
      </a>
    </div>
    <div class="col-6 col-md-2">
      <a href="{{ url_for('items.notifications') }}" class="text-decoration-none">
        <div class="stats-card bg-secondary text-white">
          <div class="icon"><i class="fas fa-bell"></i></div>
          <h2 id="expiryAlertCount">-</h2>
          <h5>åˆ°æœŸé€šçŸ¥</h5>
        </div>
      </a>
    </div>
  </div>
</div>
{%endblock%}

{%block card%}
<div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
  {%for item in items%}
  <div class="col">
    <div class="card h-100">
      <!-- æ”¶è—æŒ‰éˆ• -->
      <button type="button" 
              class="favorite-btn position-absolute top-0 start-0 m-2 z-2 {% if User.User in (item.favorites or []) %}active{% endif %}"
              onclick="event.stopPropagation(); toggleFavorite('{{item.ItemID}}', this)"
              title="{% if User.User in (item.favorites or []) %}å–æ¶ˆæ”¶è—{% else %}åŠ å…¥æ”¶è—{% endif %}">
        <i class="{% if User.User in (item.favorites or []) %}fas{% else %}far{% endif %} fa-star"></i>
      </button>
            <!-- å¡ç‰‡é ­éƒ¨ï¼šåœ–ç‰‡èˆ‡æ“ä½œ -->
            <div class="position-relative">
              <!-- æ‰¹é‡é¸æ“‡ Checkbox (åƒ…ç®¡ç†å“¡) -->
              {% if User.admin %}
              <div class="position-absolute top-0 start-0 p-2" style="z-index: 5;">
                <div class="form-check">
                  <input class="form-check-input border-2 item-select-checkbox" type="checkbox" value="{{ item.ItemID }}"  style="width: 1.5em; height: 1.5em;">
                </div>
              </div>
              {% endif %}

              <a href="{{url_for('items.item_detail', item_id=item.ItemID)}}" class="card-img-link position-relative overflow-hidden d-block" style="height: 200px;">
        {%if item.ItemPic%}
        <img
          src="{{ url_for('items.uploaded_file', filename=item.ItemThumb or item.ItemPic) }}"
          class="card-img-top h-100 w-100"
          alt="{{ item.ItemName }}"
          style="object-fit: cover"
          loading="lazy"
        />
        {%else%}
        <div class="card-img-top bg-gradient d-flex align-items-center justify-content-center h-100" 
             style="background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);">
          <i class="fas fa-image fa-4x text-white opacity-50"></i>
        </div>
        {%endif%}
        
        <!-- ç‹€æ…‹æ¨™ç±¤ -->
        <div class="position-absolute top-0 end-0 p-2 d-flex flex-column gap-1">
          {% if item.WarrantyStatus=='expired' %}
          <span class="badge bg-danger"><i class="fas fa-exclamation-triangle me-1"></i>ä¿å›ºéæœŸ</span>
          {% elif item.WarrantyStatus=='near' %}
          <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>å³å°‡åˆ°æœŸ</span>
          {% endif %}
          {% if item.UsageStatus=='expired' %}
          <span class="badge bg-danger"><i class="fas fa-hourglass-end me-1"></i>ä½¿ç”¨éæœŸ</span>
          {% elif item.UsageStatus=='near' %}
          <span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half me-1"></i>å³å°‡åˆ°æœŸ</span>
          {% endif %}
        </div>
        
        <!-- é¡å‹æ¨™ç±¤ -->
        {%if item.ItemType%}
        <div class="position-absolute bottom-0 start-0 p-2">
          <span class="badge bg-dark bg-opacity-75">
            <i class="fas fa-tag me-1"></i>{{item.ItemType}}
          </span>
        </div>
        {%endif%}
        
        <!-- æ‡¸åœæç¤º -->
        <div class="card-img-overlay d-flex align-items-center justify-content-center opacity-0 hover-overlay">
          <span class="badge bg-white text-dark fs-6">
            <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è©³æƒ…
          </span>
        </div>
      </a>
      </div>
      
      <!-- å¡ç‰‡å…§å®¹ -->
      <div class="card-body">
        <h5 class="card-title text-truncate" title="{{item.ItemName}}">
          {{item.ItemName}}
        </h5>
        <p class="card-text text-muted small mb-2">
          <i class="fas fa-hashtag me-1"></i>{{item.ItemID}}
        </p>
        
        {%if item.ItemStorePlace%}
        <div class="card-text small mb-1 quick-edit-container" data-item-id="{{item.ItemID}}">
          <i class="fas fa-map-marker-alt text-danger me-1"></i>
          <strong>ä½ç½®ï¼š</strong>
          <span class="location-display">{{item.ItemStorePlace}}</span>
          {%if User.admin%}
          <button type="button" class="btn btn-link btn-sm p-0 ms-1 quick-edit-btn d-none" 
                  onclick="startQuickEdit('{{item.ItemID}}', '{{item.ItemStorePlace}}')"
                  title="å¿«é€Ÿç·¨è¼¯ä½ç½®">
            <i class="fas fa-pencil-alt"></i>
          </button>
          {%endif%}
        </div>
        {%endif%}
        
        {%if item.ItemFloor or item.ItemRoom or item.ItemZone%}
        <p class="card-text small mb-1">
          <i class="fas fa-home text-info me-1"></i>
          {{item.ItemFloor}} {{item.ItemRoom}} {{item.ItemZone}}
        </p>
        {%endif%}
        
        {%if item.ItemOwner%}
        <p class="card-text small mb-1">
          <i class="fas fa-user text-secondary me-1"></i>
          {{item.ItemOwner}}
        </p>
        {%endif%}
        
        {%if item.WarrantyExpiry%}
        <p class="card-text small mb-1">
          <i class="fas fa-shield-alt text-success me-1"></i>
          ä¿å›ºè‡³ {{item.WarrantyExpiry}}
        </p>
        {%endif%}
      </div>
      
      <!-- å¡ç‰‡åº•éƒ¨æ“ä½œ -->
      <div class="card-footer bg-transparent">
        <div class="d-flex justify-content-between align-items-center">
          <div class="btn-group btn-group-sm">
            {%if User.admin%}
            <a href="{{ url_for('items.edititem', item_id=item.ItemID) }}" 
               class="btn btn-outline-primary"
               data-tooltip="ç·¨è¼¯ç‰©å“">
              <i class="fas fa-edit"></i>
            </a>
            {%endif%}
            <a href="{{ url_for('items.search') }}?q={{item.ItemName}}" 
               class="btn btn-outline-secondary"
               data-tooltip="æœå°‹ç›¸ä¼¼">
              <i class="fas fa-search"></i>
            </a>
          </div>
          <div class="btn-group btn-group-sm">
            <a href="{{ url_for('items.qrcode_image', item_id=item.ItemID) }}" 
               class="btn btn-outline-dark"
               data-tooltip="ä¸‹è¼‰ QR Code">
              <i class="fas fa-qrcode"></i>
            </a>
            <a href="{{ url_for('items.barcode_image', item_id=item.ItemID) }}" 
               class="btn btn-outline-dark"
               data-tooltip="ä¸‹è¼‰æ¢ç¢¼">
              <i class="fas fa-barcode"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  {%endfor%}
</div>

{%if not items%}
<div class="empty-state animate-fadeInUp">
  <i class="fas fa-box-open"></i>
  <h3>é‚„æ²’æœ‰ä»»ä½•ç‰©å“</h3>
  <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹è¨˜éŒ„æ‚¨çš„ç¬¬ä¸€å€‹ç‰©å“å§ï¼</p>
  {%if User.admin%}
  <a href="{{ url_for('items.additem') }}" class="btn btn-primary btn-lg">
    <i class="fas fa-plus me-2"></i>æ–°å¢ç¬¬ä¸€å€‹ç‰©å“
  </a>
  {%endif%}
</div>
{%endif%}

<!-- æ‰¹é‡æ“ä½œæµ®å‹•å·¥å…·åˆ— -->
{% if User.admin %}
<div id="bulkActionBar" class="bulk-action-bar bg-dark text-white p-3 shadow-lg rounded-top d-none">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            å·²é¸æ“‡ <span id="selectedCount" class="fw-bold">0</span> å€‹ç‰©å“
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-light btn-sm" onclick="showBulkMoveModal()">
                <i class="fas fa-arrows-alt me-1"></i>æ‰¹é‡ç§»å‹•
            </button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="confirmBulkDelete()">
                <i class="fas fa-trash-alt me-1"></i>æ‰¹é‡åˆªé™¤
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSelection()">
                <i class="fas fa-times me-1"></i>å–æ¶ˆ
            </button>
        </div>
    </div>
</div>

<!-- æ‰¹é‡ç§»å‹• Modal -->
<div class="modal fade" id="bulkMoveModal" tabindex="-1" aria-labelledby="bulkMoveModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkMoveModalLabel">æ‰¹é‡ç§»å‹•ç‰©å“</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>å°‡é¸å®šçš„ <span id="bulkMoveCount" class="fw-bold"></span> å€‹ç‰©å“ç§»å‹•åˆ°æ–°çš„ä½ç½®ã€‚</p>
                <div class="mb-3">
                    <label for="bulkTargetLocation" class="form-label">ç›®æ¨™ä½ç½®</label>
                    <input type="text" class="form-control" id="bulkTargetLocation" placeholder="è¼¸å…¥æ–°çš„æ”¾ç½®åœ°é»">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitBulkMove()">ç¢ºèªç§»å‹•</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{%endblock%}

{%block page%}
{% include "partials/pagination.html" %}
{%endblock%}

{%block js%}
<script>
// é¦–é æœå°‹æ¡†å³æ™‚æ¸…é™¤åŠŸèƒ½
const homeSearchInput = document.getElementById('homeSearchInput');
const homeClearBtn = document.getElementById('homeClearBtn');

function clearHomeSearch() {
  homeSearchInput.value = '';
  homeSearchInput.focus();
  homeClearBtn.classList.add('d-none');
}

if (homeSearchInput) {
  homeSearchInput.addEventListener('input', function() {
    if (this.value) {
      homeClearBtn.classList.remove('d-none');
    } else {
      homeClearBtn.classList.add('d-none');
    }
  });
  
  // ESC éµæ¸…é™¤è¼¸å…¥
  homeSearchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      clearHomeSearch();
    }
  });
}

// å¿«é€Ÿä½ç½®ç·¨è¼¯
function startQuickEdit(itemId, currentLocation) {
  const container = document.querySelector(`.quick-edit-container[data-item-id="${itemId}"]`);
  if (!container) return;
  
  const display = container.querySelector('.location-display');
  const editBtn = container.querySelector('.quick-edit-btn');
  
  // å»ºç«‹ç·¨è¼¯è¼¸å…¥æ¡†
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'form-control form-control-sm d-inline-block';
  input.style.width = 'calc(100% - 80px)';
  input.value = currentLocation;
  
  // å»ºç«‹å„²å­˜/å–æ¶ˆæŒ‰éˆ•
  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.className = 'btn btn-success btn-sm ms-1';
  saveBtn.innerHTML = '<i class="fas fa-check"></i>';
  saveBtn.onclick = () => saveQuickEdit(itemId, input.value, container, currentLocation);
  
  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.className = 'btn btn-secondary btn-sm ms-1';
  cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
  cancelBtn.onclick = () => cancelQuickEdit(container, currentLocation);
  
  // éš±è—åŸæœ¬é¡¯ç¤ºï¼Œé¡¯ç¤ºç·¨è¼¯
  display.classList.add('d-none');
  editBtn.classList.add('d-none');
  
  container.appendChild(input);
  container.appendChild(saveBtn);
  container.appendChild(cancelBtn);
  
  input.focus();
  input.select();
  
  // Enter éµå„²å­˜ï¼ŒEscape éµå–æ¶ˆ
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      saveQuickEdit(itemId, input.value, container, currentLocation);
    } else if (e.key === 'Escape') {
      cancelQuickEdit(container, currentLocation);
    }
  });
}

async function saveQuickEdit(itemId, newLocation, container, oldLocation) {
  try {
    const response = await fetch(`/api/quick-update-location/${itemId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      },
      body: JSON.stringify({ location: newLocation })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // æ›´æ–°é¡¯ç¤º
      const display = container.querySelector('.location-display');
      display.textContent = newLocation;
      cancelQuickEdit(container, newLocation);
    } else {
      alert(data.message || 'æ›´æ–°å¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('æ›´æ–°å¤±æ•—');
  }
}

function cancelQuickEdit(container, location) {
  const display = container.querySelector('.location-display');
  const editBtn = container.querySelector('.quick-edit-btn');
  
  // ç§»é™¤ç·¨è¼¯å…ƒä»¶
  const input = container.querySelector('input');
  const saveBtn = container.querySelector('.btn-success');
  const cancelBtn = container.querySelector('.btn-secondary');
  
  if (input) input.remove();
  if (saveBtn) saveBtn.remove();
  if (cancelBtn) cancelBtn.remove();
  
  // é¡¯ç¤ºåŸæœ¬å…§å®¹
  display.textContent = location;
  display.classList.remove('d-none');
  editBtn.classList.add('d-none');
}

// æ”¶è—åŠŸèƒ½
async function toggleFavorite(itemId, btn) {
  try {
    const response = await fetch(`/api/favorite/${itemId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token() }}'
      }
    });
    
    const data = await response.json();
    
    if (data.success) {
      const icon = btn.querySelector('i');
      if (data.is_favorite) {
        btn.classList.add('active');
        icon.classList.remove('far');
        icon.classList.add('fas');
        btn.title = 'å–æ¶ˆæ”¶è—';
      } else {
        btn.classList.remove('active');
        icon.classList.remove('fas');
        icon.classList.add('far');
        btn.title = 'åŠ å…¥æ”¶è—';
      }
      
      // å°å‹•ç•«æ•ˆæœ
      btn.style.transform = 'scale(1.3)';
      setTimeout(() => {
        btn.style.transform = '';
      }, 200);
    } else {
      alert(data.message || 'æ“ä½œå¤±æ•—');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('æ“ä½œå¤±æ•—');
  }
}
    // ==========================================
    // æ‰¹é‡æ“ä½œé‚è¼¯
    // ==========================================
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCountSpan = document.getElementById('selectedCount');
    const checkboxes = document.querySelectorAll('.item-select-checkbox');
    let selectedItems = new Set();
    
    function updateBulkUI() {
      if (selectedItems.size > 0) {
        bulkActionBar.style.display = 'block';
        setTimeout(() => {
            bulkActionBar.style.transform = 'translateY(0)';
        }, 10);
        selectedCountSpan.textContent = selectedItems.size;
        document.getElementById('bulkMoveCount').textContent = selectedItems.size; // Update modal count
      } else {
        bulkActionBar.style.transform = 'translateY(100%)';
        setTimeout(() => {
            if (selectedItems.size === 0) bulkActionBar.style.display = 'none';
        }, 300);
      }
    }
    
    function clearSelection() {
        checkboxes.forEach(cb => {
            cb.checked = false;
        });
        selectedItems.clear();
        updateBulkUI();
    }
    
    checkboxes.forEach(cb => {
        cb.addEventListener('change', (e) => {
            if (e.target.checked) {
                selectedItems.add(e.target.value);
            } else {
                selectedItems.delete(e.target.value);
            }
            updateBulkUI();
        });
    });
    
    // æ‰¹é‡åˆªé™¤
    function confirmBulkDelete() {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é€™ ${selectedItems.size} å€‹ç‰©å“å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
        
        const itemIds = Array.from(selectedItems);
        
        fetch("{{ url_for('items.bulk_delete') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            body: JSON.stringify({ item_ids: itemIds })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('åˆªé™¤å¤±æ•—ï¼š' + data.message);
            }
        })
        .catch(err => alert('ç™¼ç”ŸéŒ¯èª¤'));
    }
    
    // æ‰¹é‡ç§»å‹•
    const bulkMoveModal = new bootstrap.Modal(document.getElementById('bulkMoveModal'));
    
    function showBulkMoveModal() {
        document.getElementById('bulkTargetLocation').value = ''; // Clear previous input
        bulkMoveModal.show();
    }
    
    function submitBulkMove() {
        const location = document.getElementById('bulkTargetLocation').value;
        if (!location) {
            alert('è«‹è¼¸å…¥ä½ç½®');
            return;
        }
        
        const itemIds = Array.from(selectedItems);
        
        fetch("{{ url_for('items.bulk_move') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': "{{ csrf_token() }}"
            },
            body: JSON.stringify({ 
                item_ids: itemIds,
                location: location
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('ç§»å‹•å¤±æ•—ï¼š' + data.message);
            }
        })
        .catch(err => alert('ç™¼ç”ŸéŒ¯èª¤'));
    }

    // ==========================================
    // é¦–é çµ±è¨ˆæ•¸å­—å‹•æ…‹è¼‰å…¥
    // ==========================================
    document.addEventListener('DOMContentLoaded', function() {
        // è¼‰å…¥åº«å­˜è­¦å‘Šæ•¸é‡
        fetch('/api/stock/count')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const stockEl = document.getElementById('stockAlertCount');
                    if (stockEl) {
                        stockEl.textContent = data.count;
                        // è‹¥æœ‰è­¦å‘Šå‰‡åŠ ä¸Šç´…è‰²
                        if (data.count > 0) {
                            stockEl.classList.add('text-danger');
                        }
                    }
                }
            })
            .catch(err => console.error('è¼‰å…¥åº«å­˜è­¦å‘Šå¤±æ•—:', err));

        // è¼‰å…¥åˆ°æœŸé€šçŸ¥æ•¸é‡
        fetch('/api/notifications/count')
            .then(res => res.json())
            .then(data => {
                if (data.success !== false) {
                    const expiryEl = document.getElementById('expiryAlertCount');
                    if (expiryEl) {
                        // é€šçŸ¥ API å›å‚³ {expiring_soon, expired, total}
                        const total = data.total || 0;
                        expiryEl.textContent = total;
                        // è‹¥æœ‰åˆ°æœŸå‰‡åŠ ä¸Šè­¦å‘Šè‰²
                        if (data.expired > 0) {
                            expiryEl.classList.add('text-danger');
                        } else if (data.expiring_soon > 0) {
                            expiryEl.classList.add('text-warning');
                        }
                    }
                }
            })
            .catch(err => console.error('è¼‰å…¥åˆ°æœŸé€šçŸ¥å¤±æ•—:', err));
    });

  </script>
{%endblock%}
