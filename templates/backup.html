{%extends 'template.html' %}
{%block title%}å‚™ä»½èˆ‡é‚„åŸ - ç‰©å“ç®¡ç†ç³»çµ±{%endblock%}
{%block user%}{{User.User}}{%endblock%}

{%block contain%}
<div class="container-fluid">
  <!-- é é¢æ¨™é¡Œ -->
  <div class="page-header animate-fadeInUp">
    <h1>ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</h1>
    <p class="lead">åŒ¯å‡ºå®Œæ•´è³‡æ–™å‚™ä»½æˆ–å¾å‚™ä»½æª”æ¡ˆé‚„åŸç³»çµ±</p>
  </div>
</div>
{%endblock%}

{%block body%}
<div class="container-fluid">
  <div class="row g-4">
    <!-- å·¦å´ï¼šå‚™ä»½ -->
    <div class="col-lg-6">
      <div class="card h-100 animate-fadeInUp stagger-1">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-download me-2"></i>è³‡æ–™å‚™ä»½</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">
            å°‡ç³»çµ±ä¸­çš„æ‰€æœ‰è³‡æ–™åŒ¯å‡ºç‚º JSON æª”æ¡ˆï¼ŒåŒ…å«ç‰©å“ã€é¡å‹ã€ä½ç½®ç­‰æ‰€æœ‰è¨­å®šã€‚
          </p>
          
          <!-- ç›®å‰è³‡æ–™çµ±è¨ˆ -->
          <div class="row g-3 mb-4">
            <div class="col-4">
              <div class="p-3 bg-light rounded text-center">
                <div class="fs-3 fw-bold text-primary">{{ stats.total }}</div>
                <small class="text-muted">ç‰©å“</small>
              </div>
            </div>
            <div class="col-4">
              <div class="p-3 bg-light rounded text-center">
                <div class="fs-3 fw-bold text-success">{{ type_count }}</div>
                <small class="text-muted">é¡å‹</small>
              </div>
            </div>
            <div class="col-4">
              <div class="p-3 bg-light rounded text-center">
                <div class="fs-3 fw-bold text-info">{{ location_count }}</div>
                <small class="text-muted">ä½ç½®é¸é …</small>
              </div>
            </div>
          </div>
          
          <div class="alert alert-info small">
            <i class="fas fa-info-circle me-1"></i>
            å‚™ä»½æª”æ¡ˆåŒ…å«æ‰€æœ‰ç‰©å“è³‡æ–™ã€é¡å‹è¨­å®šå’Œä½ç½®é¸é …ï¼Œä½†<strong>ä¸åŒ…å«</strong>åœ–ç‰‡æª”æ¡ˆã€‚
          </div>
          
          <a href="{{ url_for('items.full_backup') }}" class="btn btn-primary btn-lg w-100">
            <i class="fas fa-download me-2"></i>ä¸‹è¼‰å®Œæ•´å‚™ä»½
          </a>
        </div>
      </div>
    </div>
    
    <!-- å³å´ï¼šé‚„åŸ -->
    <div class="col-lg-6">
      <div class="card h-100 animate-fadeInUp stagger-2">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="fas fa-upload me-2"></i>è³‡æ–™é‚„åŸ</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">
            å¾ä¹‹å‰åŒ¯å‡ºçš„ JSON å‚™ä»½æª”æ¡ˆé‚„åŸè³‡æ–™ã€‚è«‹è¬¹æ…æ“ä½œï¼
          </p>
          
          <form id="restoreForm" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <!-- æª”æ¡ˆé¸æ“‡ -->
            <div class="mb-4">
              <label class="form-label fw-bold">é¸æ“‡å‚™ä»½æª”æ¡ˆ</label>
              <input type="file" class="form-control" name="backup_file" id="backupFile" accept=".json" required>
              <small class="text-muted">åªæ”¯æ´ JSON æ ¼å¼çš„å‚™ä»½æª”æ¡ˆ</small>
            </div>
            
            <!-- é‚„åŸæ¨¡å¼ -->
            <div class="mb-4">
              <label class="form-label fw-bold">é‚„åŸæ¨¡å¼</label>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="mode" id="modeMerge" value="merge" checked>
                <label class="form-check-label" for="modeMerge">
                  <strong>åˆä½µæ¨¡å¼</strong>
                  <span class="text-muted">- ä¿ç•™ç¾æœ‰è³‡æ–™ï¼Œåªæ–°å¢æˆ–æ›´æ–°</span>
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="mode" id="modeReplace" value="replace">
                <label class="form-check-label" for="modeReplace">
                  <strong>è¦†è“‹æ¨¡å¼</strong>
                  <span class="text-muted">- åˆªé™¤é‡è¤‡é …ç›®å¾Œé‡æ–°åŒ¯å…¥</span>
                </label>
              </div>
            </div>
            
            <div class="alert alert-warning small">
              <i class="fas fa-exclamation-triangle me-1"></i>
              <strong>è­¦å‘Šï¼š</strong>é‚„åŸæ“ä½œå¯èƒ½æœƒè¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œè«‹ç¢ºä¿å·²å‚™ä»½ç›®å‰è³‡æ–™ã€‚
            </div>
            
            <button type="submit" class="btn btn-warning btn-lg w-100" id="restoreBtn">
              <i class="fas fa-upload me-2"></i>é–‹å§‹é‚„åŸ
            </button>
          </form>
          
          <!-- é‚„åŸçµæœ -->
          <div id="restoreResult" class="mt-4 d-none">
            <div class="alert" id="restoreAlert">
              <i class="fas fa-check-circle me-1"></i>
              <span id="restoreMessage"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- èªªæ˜ -->
  <div class="card mt-4 animate-fadeInUp stagger-3">
    <div class="card-body">
      <h6><i class="fas fa-question-circle me-2 text-primary"></i>å‚™ä»½èˆ‡é‚„åŸèªªæ˜</h6>
      <div class="row">
        <div class="col-md-6">
          <h6 class="text-muted mt-3">å‚™ä»½å…§å®¹</h6>
          <ul class="small text-muted">
            <li>æ‰€æœ‰ç‰©å“è³‡æ–™ï¼ˆåç¨±ã€IDã€æè¿°ã€ä½ç½®ç­‰ï¼‰</li>
            <li>æ‰€æœ‰é¡å‹è¨­å®š</li>
            <li>æ‰€æœ‰ä½ç½®é¸é …ï¼ˆæ¨“å±¤ã€æˆ¿é–“ã€å€åŸŸï¼‰</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6 class="text-muted mt-3">æ³¨æ„äº‹é …</h6>
          <ul class="small text-muted">
            <li>åœ–ç‰‡æª”æ¡ˆä¸åŒ…å«åœ¨å‚™ä»½ä¸­ï¼Œéœ€å¦è¡Œå‚™ä»½</li>
            <li>ä½¿ç”¨è€…å¸³è™Ÿè³‡æ–™ä¸åŒ…å«åœ¨å‚™ä»½ä¸­</li>
            <li>å»ºè­°å®šæœŸåŸ·è¡Œå‚™ä»½ä»¥é˜²è³‡æ–™éºå¤±</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{%endblock%}

{%block js%}
<script>
document.getElementById('restoreForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const btn = document.getElementById('restoreBtn');
  const resultDiv = document.getElementById('restoreResult');
  const alertDiv = document.getElementById('restoreAlert');
  const messageSpan = document.getElementById('restoreMessage');
  
  // ç¢ºèªå°è©±æ¡†
  if (!confirm('ç¢ºå®šè¦åŸ·è¡Œé‚„åŸå—ï¼Ÿé€™å¯èƒ½æœƒå½±éŸ¿ç¾æœ‰è³‡æ–™ã€‚')) {
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é‚„åŸä¸­...';
  
  const formData = new FormData(this);
  
  try {
    const response = await fetch('{{ url_for("items.restore_backup") }}', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    resultDiv.classList.remove('d-none');
    
    if (data.success) {
      alertDiv.className = 'alert alert-success';
      messageSpan.textContent = data.message;
    } else {
      alertDiv.className = 'alert alert-danger';
      messageSpan.textContent = data.message || 'é‚„åŸå¤±æ•—';
    }
  } catch (error) {
    resultDiv.classList.remove('d-none');
    alertDiv.className = 'alert alert-danger';
    messageSpan.textContent = 'é‚„åŸéç¨‹ç™¼ç”ŸéŒ¯èª¤';
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-upload me-2"></i>é–‹å§‹é‚„åŸ';
  }
});
</script>
{%endblock%}

